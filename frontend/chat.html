<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevNet Messenger</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #10a37f;
            --primary-dark: #0d8c6c;
            --primary-light: #12b592;
            --bg-dark: #0f0f0f;
            --bg-darker: #0a0a0a;
            --bg-light: #1a1a1a;
            --bg-lighter: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            --border: rgba(255,255,255,0.1);
            --border-light: rgba(255,255,255,0.05);
            --message-bg-own: #10a37f;
            --message-bg-other: #2a2a2a;
            --group-message: #2d4a7a;
            --online: #10a37f;
            --offline: #666666;
            --favorite: #ffd700;
            --error: #ff4757;
            --success: #10a37f;
            --warning: #ffa502;
            --gradient-primary: linear-gradient(135deg, #10a37f 0%, #1e90ff 100%);
            --gradient-accent: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
            --gradient-chat: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        .gradient-text {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* –°–∫—Ä—ã—Ç–∏–µ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        .no-scrollbar {
            scrollbar-width: none;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* ========== –ö–û–ù–¢–ï–ô–ù–ï–† ========== */
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* ========== –°–ê–ô–î–ë–ê–† ========== */
        .sidebar {
            width: 350px;
            background: var(--bg-light);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-header h2 {
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .create-group-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }
        
        .create-group-btn:hover {
            background: var(--primary-light);
        }
        
        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ */
        .user-info {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .user-info:hover {
            background: var(--bg-lighter);
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
            position: relative;
        }
        
        .user-status-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--bg-light);
            background: var(--online);
        }
        
        .user-status-dot.offline {
            background: var(--offline);
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            margin-bottom: 0.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .guest-badge {
            background: var(--primary);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
        }
        
        .user-username {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs {
            display: flex;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-light);
        }
        
        .tab {
            flex: 1;
            padding: 0.8rem;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .tab:hover {
            background: var(--bg-lighter);
            color: var(--text-primary);
        }
        
        .tab.active {
            background: var(--bg-lighter);
            color: var(--text-primary);
        }
        
        /* –ü–æ–∏—Å–∫ */
        .search-container {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .search-input {
            width: 100%;
            padding: 0.8rem 1rem;
            background: var(--bg-lighter);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .chats-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .chats-list::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chats-list::-webkit-scrollbar-thumb {
            background: var(--bg-lighter);
            border-radius: 3px;
        }
        
        .chats-list::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        .chat-item {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .chat-item:hover {
            background: var(--bg-lighter);
        }
        
        .chat-item.active {
            background: var(--bg-lighter);
            border-left: 3px solid var(--primary);
        }
        
        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
            position: relative;
            flex-shrink: 0;
        }
        
        .chat-avatar.group {
            background: var(--group-message);
        }
        
        .chat-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--bg-light);
        }
        
        .chat-status.online {
            background: var(--online);
        }
        
        .chat-status.offline {
            background: var(--offline);
        }
        
        .chat-details {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        
        .chat-name {
            font-weight: 600;
            margin-bottom: 0.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chat-type-badge {
            font-size: 0.7rem;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            background: var(--bg-lighter);
            color: var(--text-secondary);
        }
        
        .chat-type-badge.group {
            background: var(--group-message);
            color: white;
        }
        
        .chat-last-message {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* ========== –û–ë–õ–ê–°–¢–¨ –ß–ê–¢–ê ========== */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
        }
        
        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .chat-avatar-large {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .chat-avatar-large.group {
            background: var(--group-message);
        }
        
        .chat-details-large {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        
        .chat-with {
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .chat-status-info {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .typing-indicator {
            font-style: italic;
            color: var(--primary);
            animation: pulse 1.5s infinite;
        }
        
        .chat-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .action-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: none;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }
        
        .action-btn:hover {
            background: var(--bg-lighter);
            color: var(--text-primary);
        }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .messages-container {
            flex: 1;
            background: var(--bg-dark);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .no-chat-selected {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-align: center;
            padding: 2rem;
        }
        
        .no-chat-selected h2 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }
        
        .no-chat-selected p {
            font-size: 1rem;
            line-height: 1.5;
            max-width: 400px;
        }
        
        .messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: none;
        }
        
        .messages.active {
            display: block;
        }
        
        .messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .messages::-webkit-scrollbar-thumb {
            background: var(--bg-lighter);
            border-radius: 3px;
        }
        
        .messages::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 0.8rem 1rem;
            border-radius: 12px;
            max-width: 65%;
            position: relative;
            animation: fadeIn 0.3s ease-out;
            word-wrap: break-word;
        }
        
        .message.own {
            background: var(--message-bg-own);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message.other {
            background: var(--message-bg-other);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message.group {
            background: var(--group-message);
        }
        
        .message-sender {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .message-content {
            margin-bottom: 0.3rem;
            line-height: 1.5;
        }
        
        .message-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .message-image:hover {
            transform: scale(1.02);
        }
        
        .message-file {
            background: var(--bg-lighter);
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
        }
        
        .message-file:hover {
            background: var(--bg-light);
        }
        
        .message-file-icon {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .message-file-info {
            flex: 1;
        }
        
        .message-file-name {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        
        .message-file-size {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .message-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }
        
        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
        }
        
        /* –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .input-area {
            padding: 1rem 1.5rem;
            background: var(--bg-light);
            border-top: 1px solid var(--border);
            display: none;
        }
        
        .input-area.active {
            display: block;
        }
        
        .message-input-container {
            display: flex;
            gap: 0.8rem;
            align-items: flex-end;
            background: var(--bg-lighter);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 0.5rem 0.5rem 0.5rem 1rem;
        }
        
        .message-input {
            flex: 1;
            padding: 0.5rem 0;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 0.95rem;
            resize: none;
            max-height: 120px;
            min-height: 24px;
            line-height: 1.4;
            outline: none;
            font-family: inherit;
        }
        
        .message-input::placeholder {
            color: var(--text-muted);
        }
        
        .input-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .file-upload-btn {
            width: 36px;
            height: 36px;
            background: none;
            border: none;
            color: var(--text-secondary);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .file-upload-btn:hover {
            background: var(--bg-light);
            color: var(--text-primary);
        }
        
        .send-button {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .send-button:hover {
            background: var(--primary-light);
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ========== –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ========== */
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--bg-light);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 1.5rem;
        }
        
        .modal-header h3 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }
        
        .modal-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 0.8rem 1rem;
            background: var(--bg-lighter);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            background: var(--bg-lighter);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .modal-actions {
            display: flex;
            gap: 0.8rem;
            margin-top: 2rem;
        }
        
        .modal-btn {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        
        .modal-btn.primary {
            background: var(--primary);
            color: white;
        }
        
        .modal-btn.primary:hover {
            background: var(--primary-light);
        }
        
        .modal-btn.secondary {
            background: var(--bg-lighter);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .modal-btn.secondary:hover {
            background: var(--bg-light);
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            max-width: 400px;
            z-index: 1001;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        
        .notification.active {
            transform: translateX(0);
        }
        
        .notification-icon {
            font-size: 1.2rem;
        }
        
        .notification.success .notification-icon {
            color: var(--success);
        }
        
        .notification.error .notification-icon {
            color: var(--error);
        }
        
        .notification.warning .notification-icon {
            color: var(--warning);
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        
        .notification-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .notification-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.2rem;
        }
        
        /* –ú–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .user-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            display: none;
            z-index: 900;
        }
        
        .user-menu-overlay.active {
            display: block;
        }
        
        .user-menu {
            position: fixed;
            top: 100px;
            left: 30px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.5rem;
            min-width: 250px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 901;
            display: none;
        }
        
        .user-menu.active {
            display: block;
        }
        
        .menu-item {
            padding: 0.8rem 1rem;
            border: none;
            background: none;
            color: var(--text-primary);
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.95rem;
            border-radius: 8px;
        }
        
        .menu-item:hover {
            background: var(--bg-lighter);
        }
        
        .menu-item.logout {
            color: var(--error);
        }
        
        .menu-item.logout:hover {
            background: rgba(255, 71, 87, 0.1);
        }
        
        /* ========== –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–´–ô –î–ò–ó–ê–ô–ù ========== */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -100%;
                width: 100%;
                height: 100%;
                z-index: 100;
                transition: left 0.3s ease;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .sidebar-toggle {
                position: fixed;
                top: 1rem;
                left: 1rem;
                z-index: 99;
                width: 40px;
                height: 40px;
                background: var(--bg-light);
                border: 1px solid var(--border);
                border-radius: 8px;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            }
            
            .message {
                max-width: 85%;
            }
            
            .modal {
                padding: 1.5rem;
                width: 95%;
            }
            
            .notification {
                left: 20px;
                right: 20px;
                max-width: calc(100% - 40px);
            }
        }
        
        /* –ü–æ–ª–æ—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bg-lighter);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <!-- –¢–æ–≥–≥–ª–µ—Ä –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ -->
    <button class="sidebar-toggle" id="sidebarToggle" style="display: none;">
        <i class="fas fa-bars"></i>
    </button>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="container">
        <!-- –°–∞–π–¥–±–∞—Ä -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="gradient-text">DevNet Messenger</h2>
                <button class="create-group-btn" onclick="showCreateGroupModal()">
                    <i class="fas fa-users"></i> –ì—Ä—É–ø–ø–∞
                </button>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
            <div class="user-info" onclick="toggleUserMenu()">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <div class="user-name" id="userName">
                        –ì–æ—Å—Ç—å
                        <span class="guest-badge" id="guestBadge">–≥–æ—Å—Ç—å</span>
                    </div>
                    <div class="user-username" id="userUsername">@username</div>
                </div>
                <i class="fas fa-chevron-down" id="userMenuChevron"></i>
            </div>
            
            <!-- –ú–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="user-menu-overlay" id="userMenuOverlay" onclick="hideUserMenu()"></div>
            <div class="user-menu" id="userMenu">
                <button class="menu-item" onclick="showProfileModal()">
                    <i class="fas fa-user"></i> –ü—Ä–æ—Ñ–∏–ª—å
                </button>
                <button class="menu-item" onclick="showSettingsModal()">
                    <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
                <button class="menu-item logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                </button>
            </div>
            
            <!-- –í–∫–ª–∞–¥–∫–∏ -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('all')">
                    <i class="fas fa-comments"></i> –ß–∞—Ç—ã
                </button>
                <button class="tab" onclick="switchTab('users')">
                    <i class="fas fa-users"></i> –ö–æ–Ω—Ç–∞–∫—Ç—ã
                </button>
                <button class="tab" onclick="switchTab('groups')">
                    <i class="fas fa-users-cog"></i> –ì—Ä—É–ø–ø—ã
                </button>
            </div>
            
            <!-- –ü–æ–∏—Å–∫ -->
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤...">
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
            <div class="chats-list" id="chatsList">
                <!-- –ß–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
        
        <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="chat-area">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
            <div class="chat-header">
                <div class="chat-info">
                    <div class="chat-avatar-large" id="chatAvatarLarge">U</div>
                    <div class="chat-details-large">
                        <div class="chat-with" id="chatWith">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                        <div class="chat-status-info" id="chatStatusInfo">
                            <span id="typingIndicator"></span>
                        </div>
                    </div>
                </div>
                <div class="chat-actions" id="chatActions" style="display: none;">
                    <button class="action-btn" onclick="showChatInfo()">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>
            
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="messages-container">
                <div class="no-chat-selected" id="noChatSelected">
                    <div>
                        <h2 class="gradient-text">DevNet Messenger</h2>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                        <p style="font-size: 0.9rem; margin-top: 1rem; color: var(--text-secondary);">
                            üí° –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –≥—Ä—É–ø–ø—ã, –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –æ–±—â–∞–π—Ç–µ—Å—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏!
                        </p>
                    </div>
                </div>
                
                <div class="messages" id="messages">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            
            <!-- –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="input-area" id="inputArea">
                <div class="message-input-container">
                    <textarea class="message-input" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                    <div class="input-buttons">
                        <input type="file" id="fileInput" accept="image/*" style="display: none;">
                        <button class="file-upload-btn" onclick="openFileInput()">
                            <i class="fas fa-image"></i>
                        </button>
                        <button class="send-button" onclick="sendMessage()" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
    <div class="modal-overlay" id="createGroupModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="gradient-text">–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</h3>
                <p>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</p>
            </div>
            
            <form id="createGroupForm">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
                    <input type="text" class="form-input" id="groupName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <textarea class="form-textarea" id="groupDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã..."></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="modal-btn secondary" onclick="hideCreateGroupModal()">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="modal-btn primary">
                        –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="gradient-text">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                <p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–º –∞–∫–∫–∞—É–Ω—Ç–µ</p>
            </div>
            
            <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem;">
                <div class="user-avatar" style="width: 80px; height: 80px; font-size: 1.8rem;" id="profileAvatar">
                    U
                </div>
                <div>
                    <h3 style="margin-bottom: 0.5rem;" id="profileName">–ì–æ—Å—Ç—å</h3>
                    <p style="color: var(--text-secondary);" id="profileUsername">@guest</p>
                    <p style="font-size: 0.9rem; color: var(--primary);" id="profileStatus">–æ–Ω–ª–∞–π–Ω</p>
                </div>
            </div>
            
            <div style="background: var(--bg-lighter); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <p style="font-size: 0.9rem; color: var(--text-secondary);">
                    –°—Ç–∞—Ç—É—Å: <span id="profileAccountType">–ì–æ—Å—Ç–µ–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç</span>
                </p>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="modal-btn secondary" onclick="hideProfileModal()">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
                <button type="button" class="modal-btn primary" onclick="upgradeAccount()">
                    –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="gradient-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">–¢–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</label>
                <select class="form-input" id="themeSelect">
                    <option value="dark">–¢–µ–º–Ω–∞—è</option>
                    <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
                    <option value="auto">–°–∏—Å—Ç–µ–º–Ω–∞—è</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="soundNotifications" checked>
                        <span>–ó–≤—É–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="desktopNotifications" checked>
                        <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ —Ä–∞–±–æ—á–µ–º —Å—Ç–æ–ª–µ</span>
                    </label>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="modal-btn secondary" onclick="hideSettingsModal()">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="button" class="modal-btn primary" onclick="saveSettings()">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
    <div class="notification" id="notification">
        <div class="notification-icon">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title" id="notificationTitle">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>
            <div class="notification-message" id="notificationMessage">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
        </div>
        <button class="notification-close" onclick="hideNotification()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <script>
        // –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–º
        class DevNetMessenger {
            constructor() {
                this.ws = null;
                this.currentUser = null;
                this.selectedChat = null;
                this.chats = [];
                this.allUsers = [];
                this.groups = [];
                this.currentTab = 'all';
                this.typingTimeout = null;
                this.messageQueue = [];
                this.isTyping = {};
                this.isMobile = window.innerWidth <= 768;
                
                this.init();
            }
            
            async init() {
                console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DevNet Messenger...');
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥
                await this.autoLogin();
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ WebSocket
                this.setupWebSocket();
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—ã—Ç–∏–π
                this.setupEventListeners();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                await this.loadData();
                
                // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                this.setupMobile();
                
                console.log('‚úÖ DevNet Messenger –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            }
            
            async autoLogin() {
                try {
                    console.log('üîë –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥...');
                    
                    const response = await fetch('/api/auto-login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.currentUser = data.user;
                        console.log('‚úÖ –ê–≤—Ç–æ–≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω:', this.currentUser);
                        this.updateUserInfo();
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        this.showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', '–í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'success');
                    } else {
                        throw new Error(data.detail || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–≤—Ö–æ–¥–∞');
                    }
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—Ö–æ–¥–∞:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                    
                    // –°–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                    this.currentUser = {
                        id: 1,
                        username: 'guest_' + Math.floor(Math.random() * 10000),
                        display_name: '–ì–æ—Å—Ç—å',
                        is_guest: true
                    };
                    this.updateUserInfo();
                }
            }
            
            updateUserInfo() {
                // –ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const avatarElement = document.getElementById('userAvatar');
                if (avatarElement && this.currentUser) {
                    avatarElement.textContent = this.currentUser.display_name.charAt(0).toUpperCase();
                }
                
                // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const nameElement = document.getElementById('userName');
                if (nameElement && this.currentUser) {
                    nameElement.innerHTML = this.currentUser.display_name;
                }
                
                // –ë–µ–π–¥–∂ –≥–æ—Å—Ç—è
                const guestBadge = document.getElementById('guestBadge');
                if (guestBadge) {
                    guestBadge.style.display = this.currentUser.is_guest ? 'inline-block' : 'none';
                }
                
                // –Æ–∑–µ—Ä–Ω–µ–π–º
                const usernameElement = document.getElementById('userUsername');
                if (usernameElement && this.currentUser) {
                    usernameElement.textContent = `@${this.currentUser.username}`;
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
                const profileName = document.getElementById('profileName');
                const profileUsername = document.getElementById('profileUsername');
                const profileAvatar = document.getElementById('profileAvatar');
                const profileStatus = document.getElementById('profileStatus');
                const profileAccountType = document.getElementById('profileAccountType');
                
                if (profileName) profileName.textContent = this.currentUser.display_name;
                if (profileUsername) profileUsername.textContent = `@${this.currentUser.username}`;
                if (profileAvatar) profileAvatar.textContent = this.currentUser.display_name.charAt(0).toUpperCase();
                if (profileStatus) profileStatus.textContent = '–æ–Ω–ª–∞–π–Ω';
                if (profileAccountType) {
                    profileAccountType.textContent = this.currentUser.is_guest ? '–ì–æ—Å—Ç–µ–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç' : '–ü–æ–ª–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç';
                }
            }
            
            setupWebSocket() {
                if (!this.currentUser) {
                    console.error('–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è WebSocket');
                    setTimeout(() => this.setupWebSocket(), 1000);
                    return;
                }
                
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/${this.currentUser.id}`;
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                    this.showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', '–ß–∞—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π
                    this.processMessageQueue();
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        this.handleWebSocketMessage(message);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è WebSocket:', error);
                    }
                };
                
                this.ws.onclose = () => {
                    console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                    this.showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ', '–ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...', 'warning');
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                    setTimeout(() => this.setupWebSocket(), 3000);
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            }
            
            handleWebSocketMessage(message) {
                console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ WebSocket:', message);
                
                switch (message.type) {
                    case 'message':
                    case 'group_message':
                        this.handleIncomingMessage(message);
                        break;
                        
                    case 'file_message':
                    case 'group_file_message':
                        this.handleFileMessage(message);
                        break;
                        
                    case 'message_sent':
                        this.handleMessageSent(message);
                        break;
                        
                    case 'typing':
                    case 'group_typing':
                        this.handleTypingIndicator(message);
                        break;
                        
                    default:
                        console.log('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:', message);
                }
            }
            
            handleIncomingMessage(message) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫ —Ç–µ–∫—É—â–µ–º—É —á–∞—Ç—É
                const isCurrentChat = this.selectedChat && (
                    (this.selectedChat.type === 'private' && 
                     (message.to_user_id === this.currentUser.id || message.from_user_id === this.selectedChat.id)) ||
                    (this.selectedChat.type === 'group' && message.group_id === this.selectedChat.id)
                );
                
                if (isCurrentChat) {
                    this.displayMessage(message, message.from_user_id === this.currentUser.id);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
                this.updateChatLastMessage(message);
                
                // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ —á–∞—Ç –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
                if (!isCurrentChat && message.from_user_id !== this.currentUser.id) {
                    this.showMessageNotification(message);
                }
            }
            
            handleFileMessage(message) {
                this.handleIncomingMessage(message);
            }
            
            handleMessageSent(message) {
                console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, ID:', message.id);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è
                const messageElement = document.querySelector(`[data-message-id="${message.id}"]`);
                if (messageElement) {
                    messageElement.classList.add('delivered');
                }
            }
            
            handleTypingIndicator(message) {
                if (!this.selectedChat) return;
                
                const isCurrentChat = 
                    (this.selectedChat.type === 'private' && message.from_user_id === this.selectedChat.id) ||
                    (this.selectedChat.type === 'group' && message.group_id === this.selectedChat.id);
                
                if (isCurrentChat) {
                    const typingIndicator = document.getElementById('typingIndicator');
                    if (typingIndicator) {
                        typingIndicator.textContent = message.is_typing ? '–ø–µ—á–∞—Ç–∞–µ—Ç...' : '';
                        typingIndicator.className = message.is_typing ? 'typing-indicator' : '';
                    }
                }
            }
            
            async loadData() {
                await Promise.all([
                    this.loadUsers(),
                    this.loadGroups(),
                    this.loadChats()
                ]);
                
                this.renderChatsList();
            }
            
            async loadUsers() {
                try {
                    const response = await fetch('/api/users');
                    const data = await response.json();
                    this.allUsers = data.users;
                    console.log('üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', this.allUsers.length);
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                    this.allUsers = [];
                }
            }
            
            async loadGroups() {
                try {
                    const response = await fetch('/api/groups');
                    const data = await response.json();
                    this.groups = data.groups || [];
                    console.log('üë• –ì—Ä—É–ø–ø—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', this.groups.length);
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', error);
                    this.groups = [];
                }
            }
            
            async loadChats() {
                try {
                    const response = await fetch('/api/chats');
                    const data = await response.json();
                    
                    // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —á–∞—Ç—ã
                    this.chats = [
                        ...(data.private_chats || []).map(chat => ({
                            ...chat,
                            type: 'private',
                            avatar_text: chat.name.charAt(0).toUpperCase()
                        })),
                        ...(data.group_chats || []).map(group => ({
                            ...group,
                            type: 'group',
                            avatar_text: group.name.charAt(0).toUpperCase(),
                            is_online: true
                        }))
                    ];
                    
                    console.log('üí¨ –ß–∞—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', this.chats.length);
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
                    this.chats = [];
                }
            }
            
            renderChatsList() {
                const chatsList = document.getElementById('chatsList');
                if (!chatsList) return;
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —á–∞—Ç—ã –ø–æ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ
                let filteredChats = [];
                
                switch (this.currentTab) {
                    case 'all':
                        filteredChats = this.chats;
                        break;
                        
                    case 'users':
                        filteredChats = this.chats.filter(chat => chat.type === 'private');
                        break;
                        
                    case 'groups':
                        filteredChats = this.chats.filter(chat => chat.type === 'group');
                        break;
                }
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫
                const searchInput = document.getElementById('searchInput');
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                
                if (searchTerm) {
                    filteredChats = filteredChats.filter(chat => 
                        chat.name.toLowerCase().includes(searchTerm) ||
                        (chat.description && chat.description.toLowerCase().includes(searchTerm)) ||
                        (chat.username && chat.username.toLowerCase().includes(searchTerm))
                    );
                }
                
                // –†–µ–Ω–¥–µ—Ä–∏–º —á–∞—Ç—ã
                if (filteredChats.length === 0) {
                    chatsList.innerHTML = `
                        <div style="color: var(--text-muted); text-align: center; padding: 3rem 1rem;">
                            <i class="fas fa-comment-slash" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>${this.currentTab === 'all' ? '–ù–µ—Ç —á–∞—Ç–æ–≤' : 
                                this.currentTab === 'users' ? '–ù–µ—Ç –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤' : 
                                '–ù–µ—Ç –≥—Ä—É–ø–ø'}</p>
                        </div>
                    `;
                    return;
                }
                
                chatsList.innerHTML = filteredChats.map(chat => `
                    <div class="chat-item ${this.selectedChat && this.selectedChat.id === chat.id && this.selectedChat.type === chat.type ? 'active' : ''}" 
                         data-chat-id="${chat.id}" 
                         data-chat-type="${chat.type}"
                         onclick="messenger.selectChat(${chat.id}, '${chat.type}')">
                        <div class="chat-avatar ${chat.type === 'group' ? 'group' : ''}">
                            ${chat.avatar_text}
                            ${chat.type === 'private' ? `
                                <div class="chat-status ${chat.is_online ? 'online' : 'offline'}"></div>
                            ` : ''}
                        </div>
                        <div class="chat-details">
                            <div class="chat-name">
                                ${chat.name}
                                <span class="chat-type-badge ${chat.type === 'group' ? 'group' : ''}">
                                    ${chat.type === 'group' ? '–≥—Ä—É–ø–ø–∞' : '–ª–∏—á–Ω—ã–π'}
                                </span>
                            </div>
                            <div class="chat-last-message">
                                ${chat.last_message && chat.last_message.content ? 
                                    chat.last_message.content.substring(0, 50) + (chat.last_message.content.length > 50 ? '...' : '') : 
                                    chat.type === 'group' ? '–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç' : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            async selectChat(chatId, chatType) {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
                if (this.isMobile) {
                    this.hideSidebar();
                }
                
                // –ù–∞—Ö–æ–¥–∏–º —á–∞—Ç
                const chat = this.chats.find(c => c.id === chatId && c.type === chatType);
                if (!chat) {
                    console.error('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω:', chatId, chatType);
                    return;
                }
                
                this.selectedChat = chat;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                this.updateChatUI();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
                await this.loadMessages();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞
                document.getElementById('inputArea').classList.add('active');
                
                // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —Å–Ω–æ–≤–∞ (–¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ)
                this.renderChatsList();
            }
            
            updateChatUI() {
                if (!this.selectedChat) return;
                
                const chatAvatarLarge = document.getElementById('chatAvatarLarge');
                const chatWith = document.getElementById('chatWith');
                const chatStatusInfo = document.getElementById('chatStatusInfo');
                const chatActions = document.getElementById('chatActions');
                const noChatSelected = document.getElementById('noChatSelected');
                const messages = document.getElementById('messages');
                
                if (chatAvatarLarge) {
                    chatAvatarLarge.textContent = this.selectedChat.avatar_text;
                    chatAvatarLarge.className = `chat-avatar-large ${this.selectedChat.type === 'group' ? 'group' : ''}`;
                }
                
                if (chatWith) {
                    chatWith.textContent = this.selectedChat.name;
                }
                
                if (chatStatusInfo) {
                    if (this.selectedChat.type === 'private') {
                        chatStatusInfo.innerHTML = `
                            <span class="chat-status ${this.selectedChat.is_online ? 'online' : 'offline'}"></span>
                            ${this.selectedChat.is_online ? 'online' : 'offline'}
                        `;
                    } else {
                        chatStatusInfo.textContent = `${this.selectedChat.members_count || 0} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                    }
                }
                
                if (chatActions) {
                    chatActions.style.display = 'flex';
                }
                
                if (noChatSelected) {
                    noChatSelected.style.display = 'none';
                }
                
                if (messages) {
                    messages.classList.add('active');
                }
            }
            
            async loadMessages() {
                if (!this.selectedChat) return;
                
                const messagesContainer = document.getElementById('messages');
                messagesContainer.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 2rem;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
                
                try {
                    let messages = [];
                    
                    if (this.selectedChat.type === 'private') {
                        const response = await fetch(`/api/messages/${this.currentUser.id}/${this.selectedChat.id}`);
                        messages = await response.json();
                    } else {
                        const response = await fetch(`/api/group-messages/${this.selectedChat.id}`);
                        messages = await response.json();
                    }
                    
                    this.displayMessages(messages);
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                    messagesContainer.innerHTML = '<div style="color: var(--error); text-align: center; padding: 2rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                }
            }
            
            displayMessages(messages) {
                const messagesContainer = document.getElementById('messages');
                messagesContainer.innerHTML = '';
                
                if (messages.length === 0) {
                    messagesContainer.innerHTML = `
                        <div style="color: var(--text-muted); text-align: center; padding: 2rem;">
                            <i class="fas fa-comment-dots" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–º!</p>
                        </div>
                    `;
                    return;
                }
                
                messages.forEach(message => {
                    const isOwn = message.from_user_id === this.currentUser.id;
                    const messageElement = this.createMessageElement(message, isOwn);
                    messagesContainer.appendChild(messageElement);
                });
                
                this.scrollToBottom();
            }
            
            createMessageElement(message, isOwn) {
                const div = document.createElement('div');
                div.className = `message ${isOwn ? 'own' : 'other'} ${message.type === 'group' ? 'group' : ''}`;
                div.dataset.messageId = message.id;
                
                const time = new Date(message.timestamp).toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let content = '';
                
                if (message.type === 'image' || message.file_url) {
                    const isImage = message.type === 'image' || message.file_url.includes('images');
                    const url = message.file_url || message.image_url;
                    
                    if (isImage) {
                        content = `
                            <img src="${url}" class="message-image" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" onerror="this.src='https://via.placeholder.com/300x200/2a2a2a/666?text=–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'">
                            ${message.content ? `<div class="message-content">${message.content}</div>` : ''}
                        `;
                    } else {
                        const filename = message.filename || '–§–∞–π–ª';
                        const filesize = message.size ? this.formatFileSize(message.size) : '';
                        
                        content = `
                            <div class="message-file" onclick="window.open('${url}', '_blank')">
                                <div class="message-file-icon">
                                    <i class="fas ${this.getFileIcon(filename)}"></i>
                                </div>
                                <div class="message-file-info">
                                    <div class="message-file-name">${filename}</div>
                                    ${filesize ? `<div class="message-file-size">${filesize}</div>` : ''}
                                </div>
                            </div>
                            ${message.content ? `<div class="message-content">${message.content}</div>` : ''}
                        `;
                    }
                } else {
                    content = `<div class="message-content">${message.content}</div>`;
                }
                
                div.innerHTML = `
                    ${message.type === 'group' && !isOwn ? `<div class="message-sender">${this.getUserName(message.from_user_id)}</div>` : ''}
                    ${content}
                    <div class="message-footer">
                        <div class="message-time">${time}</div>
                    </div>
                `;
                
                return div;
            }
            
            getUserName(userId) {
                if (userId === this.currentUser.id) return '–í—ã';
                
                const user = this.allUsers.find(u => u.id === userId);
                return user ? user.display_name : `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId}`;
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                
                if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(ext)) {
                    return 'fa-image';
                } else if (['pdf'].includes(ext)) {
                    return 'fa-file-pdf';
                } else if (['doc', 'docx'].includes(ext)) {
                    return 'fa-file-word';
                } else if (['xls', 'xlsx'].includes(ext)) {
                    return 'fa-file-excel';
                } else if (['mp3', 'wav', 'ogg'].includes(ext)) {
                    return 'fa-file-audio';
                } else if (['mp4', 'avi', 'mov', 'mkv'].includes(ext)) {
                    return 'fa-file-video';
                } else {
                    return 'fa-file';
                }
            }
            
            async sendMessage() {
                const input = document.getElementById('messageInput');
                const content = input.value.trim();
                
                if (!content && !this.pendingFile) {
                    return;
                }
                
                if (!this.selectedChat) {
                    this.showNotification('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                    return;
                }
                
                if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                    this.showNotification('–û—à–∏–±–∫–∞', '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                    return;
                }
                
                const tempId = Date.now();
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                if (this.pendingFile) {
                    await this.sendFileMessage(content);
                    input.value = '';
                    this.pendingFile = null;
                    document.getElementById('fileInput').value = '';
                    return;
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                const messageData = {
                    type: this.selectedChat.type === 'group' ? 'group_message' : 'message',
                    content: content,
                    timestamp: new Date().toISOString()
                };
                
                if (this.selectedChat.type === 'private') {
                    messageData.to_user_id = this.selectedChat.id;
                } else {
                    messageData.group_id = this.selectedChat.id;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É
                this.displayMessage({
                    id: tempId,
                    from_user_id: this.currentUser.id,
                    content: content,
                    timestamp: new Date().toISOString(),
                    type: 'text'
                }, true);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
                this.ws.send(JSON.stringify(messageData));
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                input.value = '';
                this.autoResizeTextarea(input);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
                this.sendTypingIndicator(false);
            }
            
            async sendFileMessage(caption = '') {
                if (!this.pendingFile) return;
                
                try {
                    const formData = new FormData();
                    formData.append('file', this.pendingFile);
                    
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        const messageData = {
                            type: this.selectedChat.type === 'group' ? 'group_file_message' : 'file_message',
                            file_url: data.file.url,
                            content: caption,
                            timestamp: new Date().toISOString()
                        };
                        
                        if (this.selectedChat.type === 'private') {
                            messageData.to_user_id = this.selectedChat.id;
                        } else {
                            messageData.group_id = this.selectedChat.id;
                        }
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É
                        this.displayMessage({
                            id: Date.now(),
                            from_user_id: this.currentUser.id,
                            content: caption,
                            file_url: data.file.url,
                            filename: data.file.filename,
                            size: data.file.size,
                            timestamp: new Date().toISOString(),
                            type: data.file.type
                        }, true);
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
                        this.ws.send(JSON.stringify(messageData));
                        
                        this.showNotification('–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', '–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                    } else {
                        throw new Error(data.detail || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
                    }
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞:', error);
                    this.showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª', 'error');
                }
            }
            
            async uploadFile(file) {
                this.pendingFile = file;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                        console.log('–ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
                
                // –í—Å—Ç–∞–≤–ª—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                const input = document.getElementById('messageInput');
                input.value = `–§–∞–π–ª: ${file.name}`;
                input.focus();
                this.autoResizeTextarea(input);
            }
            
            sendTypingIndicator(isTyping) {
                if (!this.selectedChat || !this.ws || this.ws.readyState !== WebSocket.OPEN) return;
                
                clearTimeout(this.typingTimeout);
                
                if (isTyping) {
                    const typingData = {
                        type: this.selectedChat.type === 'group' ? 'group_typing' : 'typing',
                        is_typing: true
                    };
                    
                    if (this.selectedChat.type === 'private') {
                        typingData.to_user_id = this.selectedChat.id;
                    } else {
                        typingData.group_id = this.selectedChat.id;
                    }
                    
                    this.ws.send(JSON.stringify(typingData));
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                this.typingTimeout = setTimeout(() => {
                    if (this.selectedChat) {
                        const typingData = {
                            type: this.selectedChat.type === 'group' ? 'group_typing' : 'typing',
                            is_typing: false
                        };
                        
                        if (this.selectedChat.type === 'private') {
                            typingData.to_user_id = this.selectedChat.id;
                        } else {
                            typingData.group_id = this.selectedChat.id;
                        }
                        
                        this.ws.send(JSON.stringify(typingData));
                    }
                }, 2000);
            }
            
            updateChatLastMessage(message) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
                const chatIndex = this.chats.findIndex(c => 
                    (c.type === 'private' && c.id === message.from_user_id) ||
                    (c.type === 'group' && c.id === message.group_id)
                );
                
                if (chatIndex !== -1) {
                    this.chats[chatIndex].last_message = {
                        content: message.content,
                        timestamp: message.timestamp
                    };
                    
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–µ–∫—É—â–∏–π —á–∞—Ç
                    if (!this.selectedChat || this.selectedChat.id !== this.chats[chatIndex].id) {
                        this.renderChatsList();
                    }
                }
            }
            
            showMessageNotification(message) {
                // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                const senderName = this.getUserName(message.from_user_id);
                const content = message.content ? message.content.substring(0, 100) : '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
                
                this.showNotification(senderName, content, 'info');
            }
            
            processMessageQueue() {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ WebSocket –±—ã–ª –æ—Ç–∫–ª—é—á–µ–Ω
                while (this.messageQueue.length > 0 && this.ws && this.ws.readyState === WebSocket.OPEN) {
                    const message = this.messageQueue.shift();
                    this.ws.send(JSON.stringify(message));
                }
            }
            
            scrollToBottom() {
                const messagesContainer = document.getElementById('messages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }
            
            autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }
            
            showNotification(title, message, type = 'info') {
                const notification = document.getElementById('notification');
                const notificationTitle = document.getElementById('notificationTitle');
                const notificationMessage = document.getElementById('notificationMessage');
                const notificationIcon = notification.querySelector('.notification-icon i');
                
                if (!notification || !notificationTitle || !notificationMessage) return;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                notificationTitle.textContent = title;
                notificationMessage.textContent = message;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø –∏ –∏–∫–æ–Ω–∫—É
                notification.className = `notification ${type}`;
                
                switch (type) {
                    case 'success':
                        notificationIcon.className = 'fas fa-check-circle';
                        break;
                    case 'error':
                        notificationIcon.className = 'fas fa-exclamation-circle';
                        break;
                    case 'warning':
                        notificationIcon.className = 'fas fa-exclamation-triangle';
                        break;
                    default:
                        notificationIcon.className = 'fas fa-info-circle';
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                notification.classList.add('active');
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    notification.classList.remove('active');
                }, 5000);
            }
            
            hideNotification() {
                const notification = document.getElementById('notification');
                if (notification) {
                    notification.classList.remove('active');
                }
            }
            
            setupEventListeners() {
                // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter (Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)
                const messageInput = document.getElementById('messageInput');
                if (messageInput) {
                    messageInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });
                    
                    messageInput.addEventListener('input', (e) => {
                        this.autoResizeTextarea(e.target);
                        this.sendTypingIndicator(true);
                    });
                    
                    messageInput.addEventListener('focus', () => {
                        this.sendTypingIndicator(true);
                    });
                    
                    messageInput.addEventListener('blur', () => {
                        this.sendTypingIndicator(false);
                    });
                }
                
                // –ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', () => {
                        this.renderChatsList();
                    });
                }
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            this.uploadFile(e.target.files[0]);
                        }
                    });
                }
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
                const createGroupForm = document.getElementById('createGroupForm');
                if (createGroupForm) {
                    createGroupForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.createGroup();
                    });
                }
                
                // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ —Ä–∞–∑–º–µ—Ä—É –æ–∫–Ω–∞
                window.addEventListener('resize', () => {
                    this.isMobile = window.innerWidth <= 768;
                    this.toggleMobileElements();
                });
            }
            
            async createGroup() {
                const groupName = document.getElementById('groupName').value;
                const groupDescription = document.getElementById('groupDescription').value;
                
                if (!groupName.trim()) {
                    this.showNotification('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã', 'error');
                    return;
                }
                
                try {
                    const formData = new FormData();
                    formData.append('name', groupName);
                    formData.append('description', groupDescription);
                    
                    const response = await fetch('/api/groups', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.showNotification('–£—Å–ø–µ—Ö', '–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
                        this.hideCreateGroupModal();
                        
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä—É–ø–ø—ã –∏ —á–∞—Ç—ã
                        await this.loadGroups();
                        await this.loadChats();
                        this.renderChatsList();
                        
                        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –≥—Ä—É–ø–ø
                        this.switchTab('groups');
                    } else {
                        throw new Error(data.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã');
                    }
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã:', error);
                    this.showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É', 'error');
                }
            }
            
            switchTab(tabName) {
                this.currentTab = tabName;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                const activeTab = Array.from(document.querySelectorAll('.tab')).find(tab => 
                    tab.textContent.includes(tabName === 'all' ? '–ß–∞—Ç—ã' : 
                    tabName === 'users' ? '–ö–æ–Ω—Ç–∞–∫—Ç—ã' : '–ì—Ä—É–ø–ø—ã')
                );
                
                if (activeTab) {
                    activeTab.classList.add('active');
                }
                
                this.renderChatsList();
            }
            
            setupMobile() {
                this.toggleMobileElements();
                
                const sidebarToggle = document.getElementById('sidebarToggle');
                if (sidebarToggle) {
                    sidebarToggle.addEventListener('click', () => this.toggleSidebar());
                }
            }
            
            toggleMobileElements() {
                const sidebarToggle = document.getElementById('sidebarToggle');
                
                if (this.isMobile) {
                    if (sidebarToggle) sidebarToggle.style.display = 'flex';
                } else {
                    if (sidebarToggle) sidebarToggle.style.display = 'none';
                    this.showSidebar();
                }
            }
            
            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('active')) {
                    this.hideSidebar();
                } else {
                    this.showSidebar();
                }
            }
            
            showSidebar() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.add('active');
            }
            
            hideSidebar() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('active');
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å UI
        const messenger = new DevNetMessenger();

        function openFileInput() {
            document.getElementById('fileInput').click();
        }

        function sendMessage() {
            messenger.sendMessage();
        }

        function showCreateGroupModal() {
            document.getElementById('createGroupModal').classList.add('active');
        }

        function hideCreateGroupModal() {
            document.getElementById('createGroupModal').classList.remove('active');
            document.getElementById('createGroupForm').reset();
        }

        function showProfileModal() {
            document.getElementById('profileModal').classList.add('active');
            hideUserMenu();
        }

        function hideProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }

        function showSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
            hideUserMenu();
        }

        function hideSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            const userMenuOverlay = document.getElementById('userMenuOverlay');
            
            if (userMenu.classList.contains('active')) {
                hideUserMenu();
            } else {
                userMenu.classList.add('active');
                userMenuOverlay.classList.add('active');
            }
        }

        function hideUserMenu() {
            document.getElementById('userMenu').classList.remove('active');
            document.getElementById('userMenuOverlay').classList.remove('active');
        }

        function switchTab(tabName) {
            messenger.switchTab(tabName);
        }

        function showChatInfo() {
            if (messenger.selectedChat) {
                const chatType = messenger.selectedChat.type === 'group' ? '–ì—Ä—É–ø–ø–∞' : '–õ–∏—á–Ω—ã–π —á–∞—Ç';
                messenger.showNotification(
                    messenger.selectedChat.name,
                    `–¢–∏–ø: ${chatType}${messenger.selectedChat.description ? `\n–û–ø–∏—Å–∞–Ω–∏–µ: ${messenger.selectedChat.description}` : ''}`,
                    'info'
                );
            }
        }

        async function logout() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) return;
            
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    window.location.reload();
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
                messenger.showNotification('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–π—Ç–∏', 'error');
            }
        }

        async function upgradeAccount() {
            messenger.showNotification('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', '–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å', 'info');
            hideProfileModal();
        }

        function saveSettings() {
            const theme = document.getElementById('themeSelect').value;
            const soundNotifications = document.getElementById('soundNotifications').checked;
            const desktopNotifications = document.getElementById('desktopNotifications').checked;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ localStorage
            localStorage.setItem('theme', theme);
            localStorage.setItem('soundNotifications', soundNotifications);
            localStorage.setItem('desktopNotifications', desktopNotifications);
            
            messenger.showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', '–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã', 'success');
            hideSettingsModal();
        }

        function loadSettings() {
            const theme = localStorage.getItem('theme') || 'dark';
            const soundNotifications = localStorage.getItem('soundNotifications') !== 'false';
            const desktopNotifications = localStorage.getItem('desktopNotifications') !== 'false';
            
            if (document.getElementById('themeSelect')) {
                document.getElementById('themeSelect').value = theme;
            }
            
            if (document.getElementById('soundNotifications')) {
                document.getElementById('soundNotifications').checked = soundNotifications;
            }
            
            if (document.getElementById('desktopNotifications')) {
                document.getElementById('desktopNotifications').checked = desktopNotifications;
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É
            if (theme === 'light') {
                document.documentElement.style.setProperty('--bg-dark', '#f5f5f5');
                document.documentElement.style.setProperty('--bg-light', '#ffffff');
                document.documentElement.style.setProperty('--bg-lighter', '#f0f0f0');
                document.documentElement.style.setProperty('--text-primary', '#333333');
                document.documentElement.style.setProperty('--text-secondary', '#666666');
                document.documentElement.style.setProperty('--border', 'rgba(0,0,0,0.1)');
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        document.addEventListener('DOMContentLoaded', loadSettings);

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
        document.addEventListener('click', (e) => {
            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã
            const createGroupModal = document.getElementById('createGroupModal');
            if (createGroupModal && createGroupModal.classList.contains('active') && e.target === createGroupModal) {
                hideCreateGroupModal();
            }
            
            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è
            const profileModal = document.getElementById('profileModal');
            if (profileModal && profileModal.classList.contains('active') && e.target === profileModal) {
                hideProfileModal();
            }
            
            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal && settingsModal.classList.contains('active') && e.target === settingsModal) {
                hideSettingsModal();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideCreateGroupModal();
                hideProfileModal();
                hideSettingsModal();
                hideUserMenu();
            }
        });

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç messenger –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        window.messenger = messenger;
    </script>
</body>
</html>
