<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevNet Messenger</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #10a37f;
            --primary-dark: #0d8c6c;
            --primary-light: #12b592;
            --bg-dark: #0f0f0f;
            --bg-darker: #0a0a0a;
            --bg-light: #1a1a1a;
            --bg-lighter: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            --border: rgba(255,255,255,0.1);
            --border-light: rgba(255,255,255,0.05);
            --message-bg-own: #10a37f;
            --message-bg-other: #2a2a2a;
            --online: #10a37f;
            --offline: #666666;
            --favorite: #ffd700;
            --rocket-sent: #666666;
            --rocket-delivered: #10a37f;
            --rocket-read: #00bfff;
            --gradient-primary: linear-gradient(135deg, #10a37f 0%, #1e90ff 100%);
            --gradient-accent: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
            --gradient-chat: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        .gradient-text {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar {
            width: 350px;
            background: var(--bg-light);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .sidebar-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-header h2 {
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 600;
            margin-left: auto;
        }
        
        .menu-toggle {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .menu-toggle:hover {
            background: var(--bg-lighter);
            color: var(--text-primary);
        }
        
        /* –õ–µ–≤–æ–µ –º–µ–Ω—é-—à—Ç–æ—Ä–∫–∞ */
        .left-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            display: none;
            z-index: 1000;
        }
        
        .left-menu-overlay.active {
            display: block;
        }
        
        .left-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: var(--bg-light);
            border-right: 1px solid var(--border);
            transition: left 0.3s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }
        
        .left-menu.active {
            left: 0;
        }
        
        .left-menu-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .left-menu-header h3 {
            color: var(--text-primary);
            font-size: 1.2rem;
        }
        
        .close-menu {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-menu:hover {
            background: var(--bg-lighter);
            color: var(--text-primary);
        }
        
        .left-menu-content {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }
        
        .menu-section {
            margin-bottom: 2rem;
        }
        
        .menu-section-title {
            padding: 0 1.5rem 0.5rem 1.5rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .menu-item {
            padding: 0.8rem 1.5rem;
            border: none;
            background: none;
            color: var(--text-primary);
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.95rem;
        }
        
        .menu-item:hover {
            background: var(--bg-lighter);
        }
        
        .menu-item.logout {
            color: #ff4757;
        }
        
        .menu-item.logout:hover {
            background: rgba(255, 71, 87, 0.1);
        }
        
        .current-account {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .current-account-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .current-account-details {
            flex: 1;
        }
        
        .current-account-name {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        
        .current-account-username {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .tabs {
            display: flex;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-light);
        }
        
        .tab {
            flex: 1;
            padding: 0.7rem;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: var(--bg-lighter);
            color: var(--text-primary);
        }
        
        .tab:hover {
            background: var(--bg-lighter);
            color: var(--text-primary);
        }
        
        .search-container {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .search-input {
            width: 100%;
            padding: 0.7rem 1rem;
            background: var(--bg-lighter);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        .users-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        
        .user-item {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-item:hover {
            background: var(--bg-lighter);
        }
        
        .user-item.active {
            background: var(--bg-lighter);
            border-left: 3px solid var(--primary);
        }
        
        .user-item.favorite {
            border-left: 3px solid var(--favorite);
        }
        
        .user-avatar-large {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
            position: relative;
        }
        
        .user-avatar-large.favorite {
            background: var(--favorite);
            color: #000;
        }
        
        .user-avatar-large.saved {
            background: #8a2be2;
        }
        
        .user-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--bg-light);
        }
        
        .user-status.online {
            background: var(--online);
        }
        
        .user-status.offline {
            background: var(--offline);
        }
        
        .user-details {
            flex: 1;
            min-width: 0;
        }
        
        .user-name {
            font-weight: 500;
            margin-bottom: 0.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .favorite-badge {
            color: var(--favorite);
            font-size: 0.8rem;
        }
        
        .user-last-message {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .chat-avatar.favorite {
            background: var(--favorite);
            color: #000;
        }
        
        .chat-avatar.saved {
            background: #8a2be2;
        }
        
        .chat-details {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        
        .chat-with {
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chat-status {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .chat-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .menu-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: none;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }
        
        .menu-btn:hover {
            background: var(--bg-lighter);
            color: var(--text-primary);
        }
        
        /* –ú–µ–Ω—é –≤ —á–∞—Ç–µ (—Ç—Ä–∏ —Ç–æ—á–∫–∏ —Å–ø—Ä–∞–≤–∞) */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            display: none;
            z-index: 100;
        }
        
        .menu-overlay.active {
            display: block;
        }
        
        .menu {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.5rem;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 101;
        }
        
        .menu.active {
            display: block;
        }
        
        .messages-container {
            flex: 1;
            background: var(--bg-dark);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .no-chat-selected {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-align: center;
            padding: 2rem;
        }
        
        .no-chat-selected h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }
        
        .no-chat-selected p {
            font-size: 1rem;
            line-height: 1.5;
            max-width: 400px;
        }
        
        .messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: none;
        }
        
        .messages.active {
            display: block;
        }
        
        .message {
            margin-bottom: 0.8rem;
            padding: 0.6rem 0.8rem 0.4rem 0.8rem;
            border-radius: 12px;
            max-width: 65%;
            position: relative;
            animation: messageAppear 0.3s ease-out;
            word-wrap: break-word;
        }
        
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.own {
            background: var(--message-bg-own);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message.other {
            background: var(--message-bg-other);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message-content {
            margin-bottom: 0.3rem;
            line-height: 1.4;
        }
        
        .message-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }
        
        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
        }
        
        .message-status {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .rocket-icon {
            width: 14px;
            height: 14px;
            transition: all 0.3s ease;
            object-fit: contain;
        }
        
        .rocket-icon.sent {
            filter: grayscale(1) brightness(0.7);
            opacity: 0.7;
        }
        
        .rocket-icon.delivered {
            filter: sepia(1) hue-rotate(60deg) saturate(0.8);
            opacity: 0.9;
        }
        
        .rocket-icon.read {
            filter: none;
            opacity: 1;
        }
        
        /* –û–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .input-area {
            padding: 1rem 1.5rem;
            display: none;
        }
        
        .input-area.active {
            display: flex;
        }
        
        .message-input-container {
            flex: 1;
            display: flex;
            gap: 0.8rem;
            align-items: flex-end;
            background: var(--bg-lighter);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 0.3rem 0.3rem 0.3rem 1rem;
        }
        
        .message-input {
            flex: 1;
            padding: 0.5rem 0;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: none;
            max-height: 120px;
            min-height: 20px;
            line-height: 1.4;
            outline: none;
            font-family: inherit;
        }
        
        .message-input::placeholder {
            color: var(--text-muted);
        }
        
        .send-button {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .send-button:hover {
            background: var(--primary-light);
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .confirm-modal.active {
            display: flex;
        }
        
        .confirm-dialog {
            background: var(--bg-light);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .confirm-dialog h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
            font-size: 1.1rem;
        }
        
        .confirm-dialog p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.5;
            font-size: 0.9rem;
        }
        
        .confirm-buttons {
            display: flex;
            gap: 0.8rem;
            justify-content: center;
        }
        
        .confirm-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            flex: 1;
            font-size: 0.9rem;
        }
        
        .confirm-btn.delete {
            background: #ff4757;
            color: white;
        }
        
        .confirm-btn.delete:hover {
            background: #ff2e43;
        }
        
        .confirm-btn.cancel {
            background: var(--bg-lighter);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .confirm-btn.cancel:hover {
            background: var(--bg-lighter);
            opacity: 0.8;
        }
        
        /* –ê–∫–∫–∞—É–Ω—Ç —Å–≤–∏—Ç—á–µ—Ä */
        .account-switcher {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }
        
        .account-switcher.active {
            display: flex;
        }
        
        .switcher-content {
            background: var(--bg-light);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .switcher-header {
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .switcher-header h3 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }
        
        .switcher-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .account-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }
        
        .account-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-lighter);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .account-item:hover {
            background: var(--bg-light);
            border-color: var(--primary);
        }
        
        .account-item.active {
            border-color: var(--primary);
            background: rgba(16, 163, 127, 0.1);
        }
        
        .account-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .account-details {
            flex: 1;
        }
        
        .account-name {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        
        .account-username {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .switcher-actions {
            display: flex;
            gap: 0.8rem;
        }
        
        .switcher-btn {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .switcher-btn.primary {
            background: var(--primary);
            color: white;
        }
        
        .switcher-btn.primary:hover {
            background: var(--primary-light);
        }
        
        .switcher-btn.secondary {
            background: var(--bg-lighter);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .switcher-btn.secondary:hover {
            background: var(--bg-light);
        }
        
        /* –ü–æ–ª–æ—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bg-lighter);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <!-- –õ–µ–≤–æ–µ –º–µ–Ω—é-—à—Ç–æ—Ä–∫–∞ -->
    <div class="left-menu-overlay" id="leftMenuOverlay"></div>
    <div class="left-menu" id="leftMenu">
        <div class="left-menu-header">
            <h3>–ú–µ–Ω—é</h3>
            <button class="close-menu" onclick="hideLeftMenu()">‚úï</button>
        </div>
        
        <div class="current-account">
            <div class="current-account-avatar" id="currentAccountAvatar">U</div>
            <div class="current-account-details">
                <div class="current-account-name" id="currentAccountName">User</div>
                <div class="current-account-username" id="currentAccountUsername">@username</div>
            </div>
        </div>
        
        <div class="left-menu-content">
            <div class="menu-section">
                <div class="menu-section-title">–ê–∫–∫–∞—É–Ω—Ç</div>
                <button class="menu-item" onclick="showAccountSwitcher()">
                    üë§ –°–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                </button>
                <button class="menu-item" onclick="openSettings()">
                    ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
            </div>
            
            <div class="menu-section">
                <div class="menu-section-title">–ß–∞—Ç</div>
                <button class="menu-item" onclick="createNewChat()">
                    üí¨ –ù–æ–≤—ã–π —á–∞—Ç
                </button>
                <button class="menu-item" onclick="openFavorites()">
                    ‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
                </button>
            </div>
            
            <div class="menu-section">
                <button class="menu-item logout" onclick="logout()">
                    üö™ –í—ã–π—Ç–∏
                </button>
            </div>
        </div>
    </div>

    <!-- –°–∞–π–¥–±–∞—Ä -->
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="menu-toggle" onclick="showLeftMenu()">‚ãØ</button>
            <h2 class="gradient-text">DevNet</h2>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('all')">–í—Å–µ</button>
            <button class="tab" onclick="switchTab('favorites')">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
            <button class="tab" onclick="switchTab('online')">–û–Ω–ª–∞–π–Ω</button>
        </div>
        
        <div class="search-container">
            <input type="text" class="search-input" id="userSearch" placeholder="–ü–æ–∏—Å–∫...">
        </div>
        
        <div class="users-list" id="usersList">
            <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
    <div class="chat-area">
        <div class="chat-header">
            <div class="chat-info">
                <div class="chat-avatar" id="chatAvatar">U</div>
                <div class="chat-details">
                    <div class="chat-with" id="chatWith">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                    <div class="chat-status" id="chatStatus"></div>
                </div>
            </div>
            <div class="chat-actions" id="chatActions" style="display: none;">
                <button class="menu-btn" onclick="toggleChatMenu()">‚ãØ</button>
            </div>
        </div>
        
        <!-- –ú–µ–Ω—é –≤ —á–∞—Ç–µ (—Ç—Ä–∏ —Ç–æ—á–∫–∏ —Å–ø—Ä–∞–≤–∞) -->
        <div class="menu-overlay" id="menuOverlay" onclick="hideChatMenu()"></div>
        <div class="menu" id="chatMenu">
            <button class="menu-item" onclick="toggleFavorite()">
                ‚≠ê –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
            </button>
            <button class="menu-item delete" onclick="showDeleteConfirm()">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —á–∞—Ç
            </button>
        </div>
        
        <div class="messages-container">
            <div class="no-chat-selected" id="noChatSelected">
                <div>
                    <h3 class="gradient-text">DevNet Messenger</h3>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                </div>
            </div>
            
            <div class="messages" id="messages">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>
        
        <div class="input-area" id="inputArea">
            <div class="message-input-container">
                <textarea class="message-input" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                <button class="send-button" onclick="sendMessage()" id="sendButton">
                    ‚û§
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-dialog">
            <h3>–£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?</h3>
            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" onclick="hideDeleteConfirm()">–û—Ç–º–µ–Ω–∞</button>
                <button class="confirm-btn delete" onclick="deleteChatHistory()">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ê–∫–∫–∞—É–Ω—Ç —Å–≤–∏—Ç—á–µ—Ä -->
    <div class="account-switcher" id="accountSwitcher">
        <div class="switcher-content">
            <div class="switcher-header">
                <h3 class="gradient-text">–°–º–µ–Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–∞</h3>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è</p>
            </div>
            
            <div class="account-list" id="accountList">
                <!-- –°–ø–∏—Å–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
            
            <div class="switcher-actions">
                <button class="switcher-btn secondary" onclick="hideAccountSwitcher()">–û—Ç–º–µ–Ω–∞</button>
                <button class="switcher-btn primary" onclick="switchAccount()">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è</button>
            </div>
        </div>
    </div>

    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Ä–∞–∫–µ—Ç—ã
        const rocketImage = 'images/chatRocket.png';

        class DevNetChat {
            constructor() {
                this.ws = null;
                this.currentUser = null;
                this.selectedUser = null;
                this.users = [];
                this.allUsers = [];
                this.favoriteUsers = new Set();
                this.pendingMessages = new Map();
                this.availableAccounts = [];
                this.currentTab = 'all';
                this.loggedInAccounts = new Map();
                this.currentChatId = null;
            }

            async init() {
                this.loadLoggedInAccounts();
                await this.getCurrentUser();
                this.loadAvailableAccounts();
                await this.loadUsers();
                this.setupWebSocket();
                this.setupEventListeners();
                this.loadFavorites();
                this.updateLeftMenu();
            }

            loadLoggedInAccounts() {
                const savedAccounts = localStorage.getItem('logged_in_accounts');
                if (savedAccounts) {
                    const accounts = JSON.parse(savedAccounts);
                    accounts.forEach(acc => this.loggedInAccounts.set(acc.id, acc));
                }
            }

            saveLoggedInAccounts() {
                const accounts = Array.from(this.loggedInAccounts.values());
                localStorage.setItem('logged_in_accounts', JSON.stringify(accounts));
            }

            async getCurrentUser() {
                const urlParams = new URLSearchParams(window.location.search);
                let userId = parseInt(urlParams.get('user_id'));
                
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤–æ–≥–æ
                if (!userId || !this.loggedInAccounts.has(userId)) {
                    userId = 1;
                }
                
                if (this.loggedInAccounts.has(userId)) {
                    this.currentUser = this.loggedInAccounts.get(userId);
                } else {
                    // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    this.currentUser = {
                        id: userId,
                        username: `user${userId}`,
                        display_name: `User ${userId}`,
                        is_online: true
                    };
                    this.loggedInAccounts.set(userId, this.currentUser);
                    this.saveLoggedInAccounts();
                }
                
                this.updateCurrentUserDisplay();
            }

            updateCurrentUserDisplay() {
                const userElements = document.querySelectorAll('.current-user');
                userElements.forEach(element => {
                    element.innerHTML = `
                        <div class="user-avatar">${this.currentUser.username.charAt(0).toUpperCase()}</div>
                        <span>${this.currentUser.display_name}</span>
                    `;
                });
            }

            updateLeftMenu() {
                document.getElementById('currentAccountAvatar').textContent = 
                    this.currentUser.username.charAt(0).toUpperCase();
                document.getElementById('currentAccountName').textContent = this.currentUser.display_name;
                document.getElementById('currentAccountUsername').textContent = `@${this.currentUser.username}`;
            }

            async loadAvailableAccounts() {
                // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã
                const testAccounts = [
                    { id: 1, username: 'user1', display_name: 'üëë –û—Å–Ω–æ–≤–Ω–æ–π –∞–∫–∫–∞—É–Ω—Ç', is_online: true, is_main: true },
                    { id: 2, username: 'user2', display_name: 'üöÄ –¢–≤–∏–Ω–∫ –∞–∫–∫–∞—É–Ω—Ç', is_online: true, is_twin: true },
                    { id: 3, username: 'user3', display_name: 'üíº –†–∞–±–æ—á–∏–π', is_online: false },
                    { id: 4, username: 'admin', display_name: '‚ö° –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', is_online: true }
                ];

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
                testAccounts.forEach(acc => {
                    if (!this.loggedInAccounts.has(acc.id)) {
                        this.loggedInAccounts.set(acc.id, acc);
                    }
                });
                this.saveLoggedInAccounts();

                this.availableAccounts = Array.from(this.loggedInAccounts.values());
            }

            async loadUsers() {
                try {
                    const response = await fetch('/api/users');
                    const data = await response.json();
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    this.allUsers = data.users.filter(user => user.id !== this.currentUser.id);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
                    this.allUsers = this.availableAccounts.filter(acc => 
                        acc.id !== this.currentUser.id && acc.id > 0
                    );
                }

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —á–∞—Ç—ã
                this.allUsers.push({
                    id: -1,
                    username: 'favorites',
                    display_name: '‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è',
                    is_online: true,
                    is_favorite_chat: true,
                    chat_id: 'favorites_' + this.currentUser.id
                });

                this.allUsers.push({
                    id: -2,
                    username: 'saved',
                    display_name: 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è',
                    is_online: true,
                    is_saved_chat: true,
                    chat_id: 'saved_' + this.currentUser.id
                });

                this.applyCurrentFilter();
            }

            applyCurrentFilter() {
                switch (this.currentTab) {
                    case 'favorites':
                        this.users = this.allUsers.filter(user => 
                            this.favoriteUsers.has(user.id) || user.is_favorite_chat
                        );
                        break;
                    case 'online':
                        this.users = this.allUsers.filter(user => 
                            user.is_online && !user.is_favorite_chat && !user.is_saved_chat
                        );
                        break;
                    default:
                        this.users = [...this.allUsers];
                }
                this.renderUsersList();
            }

            renderUsersList() {
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = '';
                
                if (this.users.length === 0) {
                    usersList.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 2rem;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }
                
                this.users.forEach(user => {
                    const isFavorite = this.favoriteUsers.has(user.id) || user.is_favorite_chat;
                    const userElement = document.createElement('div');
                    userElement.className = `user-item ${isFavorite ? 'favorite' : ''}`;
                    
                    let avatarClass = 'user-avatar-large';
                    if (user.is_favorite_chat) avatarClass += ' favorite';
                    if (user.is_saved_chat) avatarClass += ' saved';
                    
                    userElement.innerHTML = `
                        <div class="${avatarClass}">
                            ${user.is_favorite_chat ? '‚≠ê' : user.is_saved_chat ? 'üíæ' : user.username.charAt(0).toUpperCase()}
                            ${!user.is_favorite_chat && !user.is_saved_chat ? `
                                <div class="user-status ${user.is_online ? 'online' : 'offline'}"></div>
                            ` : ''}
                        </div>
                        <div class="user-details">
                            <div class="user-name">
                                ${user.display_name}
                                ${isFavorite && !user.is_favorite_chat ? '<span class="favorite-badge">‚≠ê</span>' : ''}
                            </div>
                            <div class="user-last-message">
                                ${user.is_favorite_chat ? '–í–∞—à–∏ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è' : 
                                  user.is_saved_chat ? '–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Å–µ–±—è' : 
                                  (user.is_online ? 'online' : 'offline')}
                            </div>
                        </div>
                    `;
                    
                    userElement.addEventListener('click', () => {
                        this.selectUser(user);
                    });
                    
                    usersList.appendChild(userElement);
                });
            }

            setupWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/${this.currentUser.id}`;
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message);
                        
                        if (message.type === 'chat_deleted') {
                            this.handleChatDeleted(message);
                        } else if (message.type === 'message_sent') {
                            this.handleMessageSent(message);
                        } else if (message.type === 'error') {
                            console.error('‚ùå –û—à–∏–±–∫–∞:', message.message);
                            alert('–û—à–∏–±–∫–∞: ' + message.message);
                        } else if (message.type === 'message') {
                            this.handleIncomingMessage(message);
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    }
                };
                
                this.ws.onclose = () => {
                    console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                    setTimeout(() => this.setupWebSocket(), 3000);
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            }

            handleIncomingMessage(message) {
                console.log('üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', message);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫ —Ç–µ–∫—É—â–µ–º—É —á–∞—Ç—É
                const isCurrentChat = this.selectedUser && (
                    (this.selectedUser.is_saved_chat && message.from_user_id === this.currentUser.id) ||
                    (this.selectedUser.is_favorite_chat && message.is_favorite) ||
                    (!this.selectedUser.is_favorite_chat && !this.selectedUser.is_saved_chat && 
                     (message.from_user_id === this.selectedUser.id || message.to_user_id === this.selectedUser.id))
                );
                
                if (isCurrentChat) {
                    this.displayMessage(message, message.from_user_id === this.currentUser.id, 'read');
                }
            }

            handleChatDeleted(message) {
                if (this.selectedUser) {
                    const messagesContainer = document.getElementById('messages');
                    messagesContainer.innerHTML = '';
                    this.addWelcomeMessage('üí¨ –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –æ—á–∏—â–µ–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–±—â–µ–Ω–∏–µ!');
                }
            }

            handleMessageSent(message) {
                console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, ID:', message.id);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ "–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ"
                const messageElement = document.querySelector(`[data-message-id="${message.id}"]`);
                if (messageElement) {
                    this.updateMessageStatus(messageElement, 'delivered');
                    
                    // –°–∏–º—É–ª–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å "–ø—Ä–æ—á–∏—Ç–∞–Ω–æ" —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        this.updateMessageStatus(messageElement, 'read');
                    }, 2000);
                }
                
                // –£–¥–∞–ª—è–µ–º –∏–∑ –æ–∂–∏–¥–∞—é—â–∏—Ö
                this.pendingMessages.delete(message.id);
            }

            selectUser(user) {
                this.selectedUser = user;
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —á–∞—Ç–∞
                if (user.is_favorite_chat) {
                    this.currentChatId = 'favorites_' + this.currentUser.id;
                } else if (user.is_saved_chat) {
                    this.currentChatId = 'saved_' + this.currentUser.id;
                } else {
                    this.currentChatId = 'chat_' + Math.min(this.currentUser.id, user.id) + '_' + Math.max(this.currentUser.id, user.id);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.querySelectorAll('.user-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.currentTarget.classList.add('active');
                
                document.getElementById('chatWith').textContent = user.display_name;
                
                let avatarClass = 'chat-avatar';
                if (this.favoriteUsers.has(user.id)) avatarClass += ' favorite';
                if (user.is_saved_chat) avatarClass += ' saved';
                
                document.getElementById('chatAvatar').className = avatarClass;
                document.getElementById('chatAvatar').textContent = 
                    user.is_favorite_chat ? '‚≠ê' : user.is_saved_chat ? 'üíæ' : user.username.charAt(0).toUpperCase();
                
                if (user.is_favorite_chat) {
                    document.getElementById('chatStatus').innerHTML = '–í–∞—à–∏ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è';
                } else if (user.is_saved_chat) {
                    document.getElementById('chatStatus').innerHTML = '–ß–∞—Ç —Å —Å–∞–º–∏–º —Å–æ–±–æ–π';
                } else {
                    document.getElementById('chatStatus').innerHTML = `
                        <span class="user-status ${user.is_online ? 'online' : 'offline'}"></span>
                        ${user.is_online ? 'online' : 'offline'}
                    `;
                }
                
                document.getElementById('noChatSelected').style.display = 'none';
                document.getElementById('messages').classList.add('active');
                document.getElementById('inputArea').classList.add('active');
                document.getElementById('chatActions').style.display = 'flex';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é
                this.updateMenu();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
                if (user.is_favorite_chat) {
                    this.loadFavoriteMessages();
                } else if (user.is_saved_chat) {
                    this.loadSavedMessages();
                } else {
                    this.loadMessageHistory(user.id);
                }
                
                // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                document.getElementById('messageInput').focus();
            }

            updateMenu() {
                const menu = document.getElementById('chatMenu');
                const isFavorite = this.favoriteUsers.has(this.selectedUser.id);
                const isSpecialChat = this.selectedUser.is_favorite_chat || this.selectedUser.is_saved_chat;
                
                menu.innerHTML = `
                    ${!isSpecialChat ? `
                        <button class="menu-item" onclick="toggleFavorite()">
                            ${isFavorite ? '‚ùå –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '‚≠ê –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}
                        </button>
                    ` : ''}
                    ${!isSpecialChat ? `
                        <button class="menu-item delete" onclick="showDeleteConfirm()">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —á–∞—Ç
                        </button>
                    ` : ''}
                `;
            }

            async loadMessageHistory(otherUserId) {
                try {
                    const response = await fetch(`/api/messages/${this.currentUser.id}/${otherUserId}`);
                    const messages = await response.json();
                    
                    this.displayMessages(messages);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
                    this.displayTestMessages();
                }
            }

            loadFavoriteMessages() {
                const favoriteMessages = JSON.parse(localStorage.getItem('favorite_messages') || '[]');
                const userFavorites = favoriteMessages.filter(msg => 
                    msg.user_id === this.currentUser.id
                );
                this.displayMessages(userFavorites, true);
            }

            loadSavedMessages() {
                const savedMessages = JSON.parse(localStorage.getItem(`saved_messages_${this.currentUser.id}`) || '[]');
                this.displayMessages(savedMessages, true);
                
                if (savedMessages.length === 0) {
                    this.addWelcomeMessage('üíæ –≠—Ç–æ –≤–∞—à —á–∞—Ç —Å —Å–∞–º–∏–º —Å–æ–±–æ–π. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∑–¥–µ—Å—å –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –º—ã—Å–ª–∏ –∏–ª–∏ –∫–æ–¥.');
                }
            }

            displayMessages(messages, isSpecialChat = false) {
                const messagesContainer = document.getElementById('messages');
                messagesContainer.innerHTML = '';
                
                if (messages.length === 0 && !isSpecialChat) {
                    this.addWelcomeMessage('üí¨ –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.');
                    return;
                }
                
                messages.forEach(msg => {
                    const isOwn = msg.from_user_id === this.currentUser.id;
                    this.displayMessage(msg, isOwn, 'read');
                });
                
                this.scrollToBottom();
            }

            addWelcomeMessage(text) {
                const messagesContainer = document.getElementById('messages');
                const welcomeDiv = document.createElement('div');
                welcomeDiv.className = 'message other';
                welcomeDiv.innerHTML = `
                    <div class="message-content" style="font-style: italic; opacity: 0.8;">${text}</div>
                    <div class="message-footer">
                        <div class="message-time">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                `;
                messagesContainer.appendChild(welcomeDiv);
            }

            displayTestMessages() {
                const testMessages = [
                    {
                        id: 1,
                        from_user_id: this.selectedUser.id,
                        content: '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?',
                        timestamp: new Date(Date.now() - 300000).toISOString()
                    },
                    {
                        id: 2,
                        from_user_id: this.currentUser.id,
                        content: '–ü—Ä–∏–≤–µ—Ç! –í—Å–µ –æ—Ç–ª–∏—á–Ω–æ, —Ä–∞–±–æ—Ç–∞—é –Ω–∞–¥ –Ω–æ–≤—ã–º –ø—Ä–æ–µ–∫—Ç–æ–º.',
                        timestamp: new Date(Date.now() - 240000).toISOString()
                    }
                ];
                
                this.displayMessages(testMessages);
            }

            displayMessage(messageData, isOwn, status = 'sent') {
                const messagesContainer = document.getElementById('messages');
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
                messageDiv.dataset.messageId = messageData.id;
                
                const time = new Date(messageData.timestamp).toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // –°—Ç–∞—Ç—É—Å—ã —Ä–∞–∫–µ—Ç –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏
                let statusRockets = '';
                if (isOwn) {
                    const rocketsCount = status === 'sent' ? 1 : 2;
                    const rocketClass = status === 'sent' ? 'sent' : status === 'delivered' ? 'delivered' : 'read';
                    
                    statusRockets = `
                        <div class="message-status">
                            ${Array(rocketsCount).fill().map(() => 
                                `<img src="${rocketImage}" class="rocket-icon ${rocketClass}" alt="‚úì" onerror="this.style.display='none'">`
                            ).join('')}
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = `
                    <div class="message-content">${messageData.content}</div>
                    <div class="message-footer">
                        <div class="message-time">${time}</div>
                        ${statusRockets}
                    </div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
                
                if (isOwn && status === 'sent') {
                    this.pendingMessages.set(messageData.id, messageDiv);
                }
            }

            updateMessageStatus(messageElement, status) {
                const footer = messageElement.querySelector('.message-footer');
                if (footer) {
                    const rocketsCount = status === 'sent' ? 1 : 2;
                    const rocketClass = status === 'sent' ? 'sent' : status === 'delivered' ? 'delivered' : 'read';
                    
                    const statusHtml = `
                        <div class="message-status">
                            ${Array(rocketsCount).fill().map(() => 
                                `<img src="${rocketImage}" class="rocket-icon ${rocketClass}" alt="‚úì" onerror="this.style.display='none'">`
                            ).join('')}
                        </div>
                    `;
                    
                    const timeElement = footer.querySelector('.message-time');
                    if (timeElement) {
                        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å—Ç–∞—Ç—É—Å
                        const oldStatus = footer.querySelector('.message-status');
                        if (oldStatus) oldStatus.remove();
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
                        timeElement.insertAdjacentHTML('afterend', statusHtml);
                    }
                }
            }

            sendMessage() {
                const input = document.getElementById('messageInput');
                const content = input.value.trim();
                
                if (!content) return;
                
                if (!this.selectedUser) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                    return;
                }
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —á–∞—Ç–æ–≤
                if (this.selectedUser.is_favorite_chat) {
                    this.saveToFavorites(content);
                    input.value = '';
                    this.autoResizeTextarea(input);
                    return;
                }
                
                if (this.selectedUser.is_saved_chat) {
                    this.saveToSelf(content);
                    input.value = '';
                    this.autoResizeTextarea(input);
                    return;
                }
                
                if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                    alert('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                    return;
                }
                
                const tempId = Date.now();
                const messageData = {
                    to_user_id: this.selectedUser.id,
                    content: content,
                    type: 'text'
                };
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
                const sendButton = document.getElementById('sendButton');
                sendButton.disabled = true;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
                this.displayMessage({
                    id: tempId,
                    from_user_id: this.currentUser.id,
                    content: content,
                    timestamp: new Date().toISOString()
                }, true, 'sent');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
                this.ws.send(JSON.stringify(messageData));
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', messageData);
                
                input.value = '';
                this.autoResizeTextarea(input);
                
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    sendButton.disabled = false;
                }, 1000);
            }

            saveToFavorites(content) {
                const favoriteMessages = JSON.parse(localStorage.getItem('favorite_messages') || '[]');
                const newMessage = {
                    id: Date.now(),
                    from_user_id: this.currentUser.id,
                    content: content,
                    timestamp: new Date().toISOString(),
                    is_favorite: true,
                    user_id: this.currentUser.id
                };
                
                favoriteMessages.push(newMessage);
                localStorage.setItem('favorite_messages', JSON.stringify(favoriteMessages));
                
                this.displayMessage(newMessage, true, 'read');
            }

            saveToSelf(content) {
                const savedMessages = JSON.parse(localStorage.getItem(`saved_messages_${this.currentUser.id}`) || '[]');
                const newMessage = {
                    id: Date.now(),
                    from_user_id: this.currentUser.id,
                    content: content,
                    timestamp: new Date().toISOString(),
                    is_saved: true
                };
                
                savedMessages.push(newMessage);
                localStorage.setItem(`saved_messages_${this.currentUser.id}`, JSON.stringify(savedMessages));
                
                this.displayMessage(newMessage, true, 'read');
            }

            async deleteChatHistory() {
                if (!this.selectedUser || this.selectedUser.is_favorite_chat || this.selectedUser.is_saved_chat) return;
                
                try {
                    const response = await fetch(`/api/messages/for-all/${this.currentUser.id}/${this.selectedUser.id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                        const messagesContainer = document.getElementById('messages');
                        messagesContainer.innerHTML = '';
                        this.addWelcomeMessage('üí¨ –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –æ—á–∏—â–µ–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–±—â–µ–Ω–∏–µ!');
                        
                        this.hideDeleteConfirm();
                        hideChatMenu();
                    } else {
                        alert(result.detail || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞');
                    }
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞');
                }
            }

            scrollToBottom() {
                const messagesContainer = document.getElementById('messages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            loadFavorites() {
                const favorites = JSON.parse(localStorage.getItem('favorite_users') || '[]');
                this.favoriteUsers = new Set(favorites);
            }

            saveFavorites() {
                localStorage.setItem('favorite_users', JSON.stringify([...this.favoriteUsers]));
            }

            toggleFavorite() {
                if (!this.selectedUser || this.selectedUser.is_favorite_chat || this.selectedUser.is_saved_chat) return;
                
                if (this.favoriteUsers.has(this.selectedUser.id)) {
                    this.favoriteUsers.delete(this.selectedUser.id);
                } else {
                    this.favoriteUsers.add(this.selectedUser.id);
                }
                
                this.saveFavorites();
                this.applyCurrentFilter();
                this.updateMenu();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä —á–∞—Ç–∞
                document.getElementById('chatAvatar').className = `chat-avatar ${this.favoriteUsers.has(this.selectedUser.id) ? 'favorite' : ''}`;
                hideChatMenu();
            }

            setupEventListeners() {
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter (Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)
                document.getElementById('messageInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // –ê–≤—Ç–æ—Ä–∞–∑–º–µ—Ä textarea
                document.getElementById('messageInput').addEventListener('input', (e) => {
                    this.autoResizeTextarea(e.target);
                });

                // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                document.getElementById('userSearch').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    if (searchTerm) {
                        this.users = this.allUsers.filter(user => 
                            user.username.toLowerCase().includes(searchTerm) ||
                            (user.display_name && user.display_name.toLowerCase().includes(searchTerm))
                        );
                    } else {
                        this.applyCurrentFilter();
                    }
                    this.renderUsersList();
                });
            }

            renderAccountSwitcher() {
                const accountList = document.getElementById('accountList');
                accountList.innerHTML = '';
                
                this.availableAccounts.forEach(account => {
                    if (account.is_favorite_chat || account.is_saved_chat) return;
                    
                    const isCurrent = account.id === this.currentUser.id;
                    const accountElement = document.createElement('div');
                    accountElement.className = `account-item ${isCurrent ? 'active' : ''}`;
                    accountElement.innerHTML = `
                        <div class="account-avatar">${account.username.charAt(0).toUpperCase()}</div>
                        <div class="account-details">
                            <div class="account-name">${account.display_name}</div>
                            <div class="account-username">@${account.username}</div>
                        </div>
                        ${isCurrent ? '<div style="color: var(--primary); font-weight: 600;">‚úì –¢–µ–∫—É—â–∏–π</div>' : ''}
                    `;
                    
                    accountElement.addEventListener('click', () => {
                        document.querySelectorAll('.account-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        accountElement.classList.add('active');
                    });
                    
                    accountList.appendChild(accountElement);
                });
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–µ–Ω—é
        function showLeftMenu() {
            document.getElementById('leftMenuOverlay').classList.add('active');
            document.getElementById('leftMenu').classList.add('active');
        }

        function hideLeftMenu() {
            document.getElementById('leftMenuOverlay').classList.remove('active');
            document.getElementById('leftMenu').classList.remove('active');
        }

        function toggleChatMenu() {
            const menu = document.getElementById('chatMenu');
            const overlay = document.getElementById('menuOverlay');
            
            if (menu.classList.contains('active')) {
                hideChatMenu();
            } else {
                menu.classList.add('active');
                overlay.classList.add('active');
            }
        }

        function hideChatMenu() {
            document.getElementById('chatMenu').classList.remove('active');
            document.getElementById('menuOverlay').classList.remove('active');
        }

        function switchTab(tabName) {
            chat.currentTab = tabName;
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            chat.applyCurrentFilter();
        }

        function toggleFavorite() {
            chat.toggleFavorite();
        }

        function showAccountSwitcher() {
            chat.renderAccountSwitcher();
            document.getElementById('accountSwitcher').classList.add('active');
            hideLeftMenu();
        }

        function hideAccountSwitcher() {
            document.getElementById('accountSwitcher').classList.remove('active');
        }

        function switchAccount() {
            const selectedAccount = document.querySelector('.account-item.active');
            if (!selectedAccount) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è');
                return;
            }
            
            const accountIndex = Array.from(document.querySelectorAll('.account-item')).indexOf(selectedAccount);
            const account = chat.availableAccounts[accountIndex];
            
            if (account.id === chat.currentUser.id) {
                alert('–≠—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç —É–∂–µ –≤—ã–±—Ä–∞–Ω');
                return;
            }
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
            window.location.href = `/chat?user_id=${account.id}`;
        }

        function showDeleteConfirm() {
            hideChatMenu();
            if (!chat.selectedUser) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }
            if (chat.selectedUser.is_favorite_chat || chat.selectedUser.is_saved_chat) {
                alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —á–∞—Ç');
                return;
            }
            document.getElementById('confirmModal').classList.add('active');
        }

        function hideDeleteConfirm() {
            document.getElementById('confirmModal').classList.remove('active');
        }

        function deleteChatHistory() {
            chat.deleteChatHistory();
        }

        function openSettings() {
            alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –±—É–¥—É—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö');
            hideLeftMenu();
        }

        function createNewChat() {
            alert('–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±—É–¥—É—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö');
            hideLeftMenu();
        }

        function openFavorites() {
            chat.currentTab = 'favorites';
            chat.applyCurrentFilter();
            hideLeftMenu();
        }

        async function logout() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) return;
            
            try {
                const userId = chat.currentUser.id;
                await fetch(`/api/logout/${userId}`, {
                    method: 'POST'
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
            } finally {
                localStorage.clear();
                window.location.href = '/';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞
        const chat = new DevNetChat();
        document.addEventListener('DOMContentLoaded', () => {
            chat.init();
        });

        function sendMessage() {
            chat.sendMessage();
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏—Ö
        document.getElementById('confirmModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('confirmModal')) {
                hideDeleteConfirm();
            }
        });

        document.getElementById('accountSwitcher').addEventListener('click', (e) => {
            if (e.target === document.getElementById('accountSwitcher')) {
                hideAccountSwitcher();
            }
        });

        document.getElementById('leftMenuOverlay').addEventListener('click', hideLeftMenu);

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideChatMenu();
                hideDeleteConfirm();
                hideAccountSwitcher();
                hideLeftMenu();
            }
        });
    </script>
</body>
</html>
