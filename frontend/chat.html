<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevNet Messenger</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #10a37f;
            --primary-dark: #0d8c6c;
            --primary-light: #12b592;
            --bg-dark: #0f0f0f;
            --bg-darker: #0a0a0a;
            --bg-light: #1a1a1a;
            --bg-lighter: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            --border: rgba(255,255,255,0.1);
            --border-light: rgba(255,255,255,0.05);
            --message-bg-own: #10a37f;
            --message-bg-other: #2a2a2a;
            --group-message: #2d4a7a;
            --channel-message: #5a2d7a;
            --online: #10a37f;
            --offline: #666666;
            --favorite: #ffd700;
            --sticker-bg: rgba(255,255,255,0.05);
            --gradient-primary: linear-gradient(135deg, #10a37f 0%, #1e90ff 100%);
            --gradient-accent: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
            --gradient-chat: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .gradient-text {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar {
            width: 350px;
            background: var(--bg-light);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .sidebar-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-header h2 {
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .menu-toggle {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .menu-toggle:hover {
            background: var(--bg-lighter);
            color: var(--text-primary);
        }
        
        /* –õ–µ–≤–æ–µ –º–µ–Ω—é-—à—Ç–æ—Ä–∫–∞ */
        .left-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            display: none;
            z-index: 1000;
        }
        
        .left-menu-overlay.active {
            display: block;
        }
        
        .left-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: var(--bg-light);
            border-right: 1px solid var(--border);
            transition: left 0.3s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }
        
        .left-menu.active {
            left: 0;
        }
        
        .left-menu-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .left-menu-header h3 {
            color: var(--text-primary);
            font-size: 1.2rem;
        }
        
        .close-menu {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-menu:hover {
            background: var(--bg-lighter);
            color: var(--text-primary);
        }
        
        .left-menu-content {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }
        
        .menu-section {
            margin-bottom: 2rem;
        }
        
        .menu-section-title {
            padding: 0 1.5rem 0.5rem 1.5rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .menu-item {
            padding: 0.8rem 1.5rem;
            border: none;
            background: none;
            color: var(--text-primary);
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.95rem;
            border-radius: 0;
        }
        
        .menu-item:hover {
            background: var(--bg-lighter);
        }
        
        .menu-item.logout {
            color: #ff4757;
        }
        
        .menu-item.logout:hover {
            background: rgba(255, 71, 87, 0.1);
        }
        
        .current-account {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .current-account-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .current-account-details {
            flex: 1;
        }
        
        .current-account-name {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        
        .current-account-username {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .guest-badge {
            background: var(--primary);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
        }
        
        .tabs {
            display: flex;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-light);
        }
        
        .tab {
            flex: 1;
            padding: 0.7rem;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .tab.active {
            background: var(--bg-lighter);
            color: var(--text-primary);
        }
        
        .tab:hover {
            background: var(--bg-lighter);
            color: var(--text-primary);
        }
        
        .search-container {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .search-input {
            width: 100%;
            padding: 0.7rem 1rem;
            background: var(--bg-lighter);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        
        .chat-item {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .chat-item:hover {
            background: var(--bg-lighter);
        }
        
        .chat-item.active {
            background: var(--bg-lighter);
            border-left: 3px solid var(--primary);
        }
        
        .chat-item.favorite {
            border-left: 3px solid var(--favorite);
        }
        
        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
            position: relative;
        }
        
        .chat-avatar.group {
            background: var(--group-message);
        }
        
        .chat-avatar.channel {
            background: var(--channel-message);
        }
        
        .chat-avatar.favorite {
            background: var(--favorite);
            color: #000;
        }
        
        .chat-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--bg-light);
        }
        
        .chat-status.online {
            background: var(--online);
        }
        
        .chat-status.offline {
            background: var(--offline);
        }
        
        .chat-details {
            flex: 1;
            min-width: 0;
        }
        
        .chat-name {
            font-weight: 500;
            margin-bottom: 0.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chat-type {
            font-size: 0.7rem;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            background: var(--bg-lighter);
            color: var(--text-secondary);
        }
        
        .chat-type.group {
            background: var(--group-message);
            color: white;
        }
        
        .chat-type.channel {
            background: var(--channel-message);
            color: white;
        }
        
        .chat-type.private {
            background: var(--primary);
            color: white;
        }
        
        .chat-last-message {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .chat-avatar-large {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .chat-avatar-large.group {
            background: var(--group-message);
        }
        
        .chat-avatar-large.channel {
            background: var(--channel-message);
        }
        
        .chat-details-large {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        
        .chat-with {
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chat-status-large {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .chat-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .action-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: none;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }
        
        .action-btn:hover {
            background: var(--bg-lighter);
            color: var(--text-primary);
        }
        
        /* –ú–µ–Ω—é –≤ —á–∞—Ç–µ */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            display: none;
            z-index: 100;
        }
        
        .menu-overlay.active {
            display: block;
        }
        
        .chat-menu {
            position: fixed;
            top: 70px;
            right: 20px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.5rem;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 101;
        }
        
        .chat-menu.active {
            display: block;
        }
        
        .messages-container {
            flex: 1;
            background: var(--bg-dark);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .no-chat-selected {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-align: center;
            padding: 2rem;
        }
        
        .no-chat-selected h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }
        
        .no-chat-selected p {
            font-size: 1rem;
            line-height: 1.5;
            max-width: 400px;
        }
        
        .messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: none;
        }
        
        .messages.active {
            display: block;
        }
        
        .message {
            margin-bottom: 0.8rem;
            padding: 0.6rem 0.8rem 0.4rem 0.8rem;
            border-radius: 12px;
            max-width: 65%;
            position: relative;
            animation: fadeIn 0.3s ease-out;
            word-wrap: break-word;
        }
        
        .message.own {
            background: var(--message-bg-own);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message.other {
            background: var(--message-bg-other);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message.group {
            background: var(--group-message);
        }
        
        .message.channel {
            background: var(--channel-message);
        }
        
        .message-sender {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .message-content {
            margin-bottom: 0.3rem;
            line-height: 1.4;
        }
        
        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 8px;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .message-image:hover {
            transform: scale(1.02);
        }
        
        .message-caption {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .message-sticker {
            background: var(--sticker-bg);
            padding: 0.5rem;
            border-radius: 8px;
            display: inline-block;
        }
        
        .sticker-img {
            width: 128px;
            height: 128px;
            object-fit: contain;
        }
        
        .message-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }
        
        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
        }
        
        .message-status {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        /* –û–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .input-area {
            padding: 1rem 1.5rem;
            display: none;
        }
        
        .input-area.active {
            display: flex;
            flex-direction: column;
        }
        
        .input-tools {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .tool-btn {
            width: 36px;
            height: 36px;
            background: none;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .tool-btn:hover {
            background: var(--bg-lighter);
            color: var(--text-primary);
            border-color: var(--primary);
        }
        
        .message-input-container {
            flex: 1;
            display: flex;
            gap: 0.8rem;
            align-items: flex-end;
            background: var(--bg-lighter);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 0.3rem 0.3rem 0.3rem 1rem;
        }
        
        .message-input {
            flex: 1;
            padding: 0.5rem 0;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: none;
            max-height: 120px;
            min-height: 20px;
            line-height: 1.4;
            outline: none;
            font-family: inherit;
        }
        
        .message-input::placeholder {
            color: var(--text-muted);
        }
        
        .send-button {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .send-button:hover {
            background: var(--primary-light);
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-light);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .modal-header h3 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }
        
        .modal-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.7rem 1rem;
            background: var(--bg-lighter);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-textarea {
            width: 100%;
            padding: 0.7rem 1rem;
            background: var(--bg-lighter);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .form-checkbox input {
            width: 18px;
            height: 18px;
        }
        
        .modal-actions {
            display: flex;
            gap: 0.8rem;
            margin-top: 1.5rem;
        }
        
        .modal-btn {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .modal-btn.primary {
            background: var(--primary);
            color: white;
        }
        
        .modal-btn.primary:hover {
            background: var(--primary-light);
        }
        
        .modal-btn.secondary {
            background: var(--bg-lighter);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .modal-btn.secondary:hover {
            background: var(--bg-light);
        }
        
        .modal-btn.danger {
            background: #ff4757;
            color: white;
        }
        
        .modal-btn.danger:hover {
            background: #ff2e43;
        }
        
        /* –°—Ç–∏–∫–µ—Ä—ã */
        .stickers-modal {
            max-width: 400px;
        }
        
        .sticker-packs {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .sticker-pack {
            background: var(--bg-lighter);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sticker-pack:hover {
            background: var(--bg-light);
            border-color: var(--primary);
        }
        
        .sticker-pack-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .sticker-pack-name {
            font-weight: 600;
        }
        
        .sticker-pack-publisher {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .sticker-pack-stickers {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .sticker-item {
            width: 80px;
            height: 80px;
            padding: 0.5rem;
            background: var(--bg-dark);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sticker-item:hover {
            background: var(--bg-lighter);
            transform: scale(1.05);
        }
        
        .sticker-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        /* –ê–∫–∫–∞—É–Ω—Ç —Å–≤–∏—Ç—á–µ—Ä */
        .account-switcher {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }
        
        .account-switcher.active {
            display: flex;
        }
        
        .switcher-content {
            background: var(--bg-light);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .account-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }
        
        .account-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-lighter);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .account-item:hover {
            background: var(--bg-light);
            border-color: var(--primary);
        }
        
        .account-item.active {
            border-color: var(--primary);
            background: rgba(16, 163, 127, 0.1);
        }
        
        .account-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .account-details {
            flex: 1;
        }
        
        .account-name {
            font-weight: 600;
            margin-bottom: 0.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .account-username {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ */
        .file-upload {
            display: none;
        }
        
        .upload-preview {
            display: none;
            margin-bottom: 0.5rem;
        }
        
        .upload-preview.active {
            display: block;
        }
        
        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
        }
        
        .preview-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        /* –ü–æ–ª–æ—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bg-lighter);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ */
        .typing-indicator {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-left: 1rem;
            display: none;
        }
        
        .typing-indicator.active {
            display: block;
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <!-- –õ–µ–≤–æ–µ –º–µ–Ω—é-—à—Ç–æ—Ä–∫–∞ -->
    <div class="left-menu-overlay" id="leftMenuOverlay"></div>
    <div class="left-menu" id="leftMenu">
        <div class="left-menu-header">
            <h3>–ú–µ–Ω—é</h3>
            <button class="close-menu" onclick="hideLeftMenu()">‚úï</button>
        </div>
        
        <div class="current-account">
            <div class="current-account-avatar" id="currentAccountAvatar">U</div>
            <div class="current-account-details">
                <div class="current-account-name" id="currentAccountName">
                    User
                    <span class="guest-badge" id="guestBadge" style="display: none;">–ì–û–°–¢–¨</span>
                </div>
                <div class="current-account-username" id="currentAccountUsername">@username</div>
            </div>
        </div>
        
        <div class="left-menu-content">
            <div class="menu-section">
                <div class="menu-section-title">–ê–∫–∫–∞—É–Ω—Ç</div>
                <button class="menu-item" onclick="showAccountSwitcher()">
                    <i class="fas fa-user-friends"></i> –°–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                </button>
                <button class="menu-item" onclick="showRegisterModal()">
                    <i class="fas fa-user-plus"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
            </div>
            
            <div class="menu-section">
                <div class="menu-section-title">–ß–∞—Ç</div>
                <button class="menu-item" onclick="showNewGroupModal()">
                    <i class="fas fa-users"></i> –ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞
                </button>
                <button class="menu-item" onclick="showNewChannelModal()">
                    <i class="fas fa-bullhorn"></i> –ù–æ–≤—ã–π –∫–∞–Ω–∞–ª
                </button>
                <button class="menu-item" onclick="openFavorites()">
                    <i class="fas fa-star"></i> –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
                </button>
            </div>
            
            <div class="menu-section">
                <button class="menu-item logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                </button>
            </div>
        </div>
    </div>

    <!-- –°–∞–π–¥–±–∞—Ä -->
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="menu-toggle" onclick="showLeftMenu()">
                <i class="fas fa-bars"></i>
            </button>
            <h2 class="gradient-text">DevNet</h2>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('all')">
                <i class="fas fa-comments"></i> –í—Å–µ
            </button>
            <button class="tab" onclick="switchTab('groups')">
                <i class="fas fa-users"></i> –ì—Ä—É–ø–ø—ã
            </button>
            <button class="tab" onclick="switchTab('channels')">
                <i class="fas fa-bullhorn"></i> –ö–∞–Ω–∞–ª—ã
            </button>
        </div>
        
        <div class="search-container">
            <input type="text" class="search-input" id="chatSearch" placeholder="–ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤...">
        </div>
        
        <div class="chats-list" id="chatsList">
            <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
    <div class="chat-area">
        <div class="chat-header">
            <div class="chat-info">
                <div class="chat-avatar-large" id="chatAvatar">U</div>
                <div class="chat-details-large">
                    <div class="chat-with" id="chatWith">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                    <div class="chat-status-large" id="chatStatus">
                        <span class="typing-indicator" id="typingIndicator">–ø–µ—á–∞—Ç–∞–µ—Ç...</span>
                    </div>
                </div>
            </div>
            <div class="chat-actions" id="chatActions" style="display: none;">
                <button class="action-btn" onclick="toggleStickers()" title="–°—Ç–∏–∫–µ—Ä—ã">
                    <i class="fas fa-smile"></i>
                </button>
                <button class="action-btn" onclick="toggleChatMenu()" title="–ú–µ–Ω—é">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        </div>
        
        <!-- –ú–µ–Ω—é –≤ —á–∞—Ç–µ -->
        <div class="menu-overlay" id="menuOverlay" onclick="hideChatMenu()"></div>
        <div class="chat-menu" id="chatMenu">
            <button class="menu-item" onclick="toggleFavorite()">
                <i class="fas fa-star"></i> –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
            </button>
            <button class="menu-item delete" onclick="showDeleteConfirm()">
                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å —á–∞—Ç
            </button>
        </div>
        
        <div class="messages-container">
            <div class="no-chat-selected" id="noChatSelected">
                <div>
                    <h3 class="gradient-text">DevNet Messenger</h3>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                        <i class="fas fa-info-circle"></i> –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –≥—Ä—É–ø–ø—ã, –∫–∞–Ω–∞–ª—ã, –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å—Ç–∏–∫–µ—Ä—ã –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è!
                    </p>
                </div>
            </div>
            
            <div class="messages" id="messages">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>
        
        <div class="input-area" id="inputArea">
            <div class="input-tools">
                <button class="tool-btn" onclick="attachImage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                    <i class="fas fa-image"></i>
                </button>
                <button class="tool-btn" onclick="attachFile()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª">
                    <i class="fas fa-paperclip"></i>
                </button>
                <button class="tool-btn" onclick="showStickersModal()" title="–°—Ç–∏–∫–µ—Ä—ã">
                    <i class="fas fa-smile"></i>
                </button>
            </div>
            
            <div class="upload-preview" id="uploadPreview">
                <!-- –ü—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
            </div>
            
            <div class="message-input-container">
                <textarea class="message-input" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                <button class="send-button" onclick="sendMessage()" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
    <div class="modal" id="newGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="gradient-text">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h3>
                <p>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É –¥–ª—è –æ–±—â–µ–Ω–∏—è</p>
            </div>
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
                <input type="text" class="form-input" id="groupName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
            </div>
            <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea class="form-textarea" id="groupDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã"></textarea>
            </div>
            <div class="form-checkbox">
                <input type="checkbox" id="groupIsPublic" checked>
                <label>–ü—É–±–ª–∏—á–Ω–∞—è –≥—Ä—É–ø–ø–∞</label>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="hideNewGroupModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn primary" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞ -->
    <div class="modal" id="newChannelModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="gradient-text">–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</h3>
                <p>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</p>
            </div>
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</label>
                <input type="text" class="form-input" id="channelName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞">
            </div>
            <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea class="form-textarea" id="channelDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞"></textarea>
            </div>
            <div class="form-checkbox">
                <input type="checkbox" id="channelIsPublic" checked>
                <label>–ü—É–±–ª–∏—á–Ω—ã–π –∫–∞–Ω–∞–ª</label>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="hideNewChannelModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn primary" onclick="createChannel()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="gradient-text">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</h3>
                <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç</p>
            </div>
            <div class="form-group">
                <label class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                <input type="text" class="form-input" id="registerUsername" placeholder="username">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="registerEmail" placeholder="email@example.com">
            </div>
            <div class="form-group">
                <label class="form-label">–ò–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                <input type="text" class="form-input" id="registerDisplayName" placeholder="–í–∞—à–µ –∏–º—è">
            </div>
            <div class="form-group">
                <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" class="form-input" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="hideRegisterModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn primary" onclick="registerUser()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ç–∏–∫–µ—Ä–æ–≤ -->
    <div class="modal" id="stickersModal">
        <div class="modal-content stickers-modal">
            <div class="modal-header">
                <h3 class="gradient-text">–°—Ç–∏–∫–µ—Ä—ã</h3>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–∫–µ—Ä –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏</p>
            </div>
            <div class="sticker-packs" id="stickerPacks">
                <!-- –°—Ç–∏–∫–µ—Ä–ø–∞–∫–∏ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="hideStickersModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?</h3>
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="hideDeleteConfirm()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn danger" onclick="deleteChatHistory()">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ê–∫–∫–∞—É–Ω—Ç —Å–≤–∏—Ç—á–µ—Ä -->
    <div class="account-switcher" id="accountSwitcher">
        <div class="switcher-content">
            <div class="modal-header">
                <h3 class="gradient-text">–°–º–µ–Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–∞</h3>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</p>
            </div>
            
            <div class="account-list" id="accountList">
                <!-- –°–ø–∏—Å–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="hideAccountSwitcher()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn primary" onclick="autoCreateAccount()">
                    <i class="fas fa-plus"></i> –ù–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç
                </button>
                <button class="modal-btn primary" onclick="switchAccount()">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è</button>
            </div>
        </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–µ –∏–Ω–ø—É—Ç—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
    <input type="file" id="imageUpload" class="file-upload" accept="image/*" onchange="handleImageUpload(event)">
    <input type="file" id="fileUpload" class="file-upload" onchange="handleFileUpload(event)">

    <script>
        class DevNetMessenger {
            constructor() {
                this.ws = null;
                this.currentUser = null;
                this.selectedChat = null;
                this.chats = [];
                this.allChats = [];
                this.groups = [];
                this.channels = [];
                this.privateChats = [];
                this.stickerPacks = [];
                this.currentTab = 'all';
                this.typingTimeout = null;
                this.uploadedFile = null;
                this.typingUsers = new Set();
                this.favoriteChats = new Set();
                this.loggedInAccounts = new Map();
            }

            async init() {
                await this.autoLogin();
                await this.loadStickerPacks();
                await this.loadChats();
                this.setupWebSocket();
                this.setupEventListeners();
                this.updateLeftMenu();
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–∏—Ç—á–µ—Ä –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                if (this.loggedInAccounts.size === 0) {
                    setTimeout(() => this.showAccountSwitcher(), 500);
                }
            }

            async autoLogin() {
                try {
                    const response = await fetch('/api/auto-login', {
                        method: 'POST'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.currentUser = data.user;
                        this.loggedInAccounts.set(this.currentUser.id, this.currentUser);
                        this.saveLoggedInAccounts();
                        console.log('‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω:', this.currentUser);
                    } else {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–π—Ç–∏');
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—Ö–æ–¥–∞:', error);
                    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    this.currentUser = {
                        id: Date.now(),
                        username: 'guest_' + Date.now(),
                        display_name: '–ì–æ—Å—Ç—å',
                        is_guest: true
                    };
                    this.loggedInAccounts.set(this.currentUser.id, this.currentUser);
                    this.saveLoggedInAccounts();
                }
            }

            async loadStickerPacks() {
                try {
                    const response = await fetch('/api/stickers');
                    const data = await response.json();
                    this.stickerPacks = data.packs;
                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω—ã —Å—Ç–∏–∫–µ—Ä–ø–∞–∫–∏:', this.stickerPacks.length);
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∏–∫–µ—Ä–æ–≤:', error);
                    // –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ç–∏–∫–µ—Ä—ã
                    this.stickerPacks = [
                        {
                            id: 1,
                            name: "Cute Animals",
                            publisher: "DevNet",
                            stickers: [
                                { id: 1, emoji: "üò∫", url: "https://via.placeholder.com/128" },
                                { id: 2, emoji: "üê∂", url: "https://via.placeholder.com/128" },
                                { id: 3, emoji: "üê∞", url: "https://via.placeholder.com/128" }
                            ]
                        }
                    ];
                }
            }

            async loadChats() {
                try {
                    const response = await fetch('/api/chats');
                    const data = await response.json();
                    
                    this.groups = data.groups || [];
                    this.channels = data.channels || [];
                    this.privateChats = data.private_chats || [];
                    
                    // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —á–∞—Ç—ã
                    this.allChats = [
                        ...this.groups.map(g => ({ ...g, type: 'group' })),
                        ...this.channels.map(c => ({ ...c, type: 'channel' })),
                        ...this.privateChats.map(p => ({ ...p, type: 'private' }))
                    ];
                    
                    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω—ã —á–∞—Ç—ã: ${this.allChats.length} –≤—Å–µ–≥–æ`);
                    console.log(`   –ì—Ä—É–ø–ø—ã: ${this.groups.length}, –ö–∞–Ω–∞–ª—ã: ${this.channels.length}, –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ: ${this.privateChats.length}`);
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
                    
                    // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                    this.groups = [
                        { id: 1, name: "DevNet Team", description: "–ö–æ–º–∞–Ω–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤", members_count: 5, type: "group" },
                        { id: 2, name: "Secret Project", description: "–°–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç", members_count: 3, type: "group" }
                    ];
                    
                    this.channels = [
                        { id: 3, name: "Tech News", description: "–ù–æ–≤–æ—Å—Ç–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π", members_count: 10, type: "channel" }
                    ];
                    
                    this.allChats = [...this.groups, ...this.channels];
                }
                
                this.applyCurrentFilter();
            }

            applyCurrentFilter() {
                switch (this.currentTab) {
                    case 'groups':
                        this.chats = this.allChats.filter(chat => chat.type === 'group');
                        break;
                    case 'channels':
                        this.chats = this.allChats.filter(chat => chat.type === 'channel');
                        break;
                    default:
                        this.chats = [...this.allChats];
                }
                this.renderChatsList();
            }

            renderChatsList() {
                const chatsList = document.getElementById('chatsList');
                chatsList.innerHTML = '';
                
                if (this.chats.length === 0) {
                    chatsList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —á–∞—Ç–æ–≤</p>
                            <button onclick="showNewGroupModal()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary); border: none; border-radius: 8px; color: white; cursor: pointer;">
                                <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
                            </button>
                        </div>
                    `;
                    return;
                }
                
                this.chats.forEach(chat => {
                    const isFavorite = this.favoriteChats.has(chat.id);
                    const chatElement = document.createElement('div');
                    chatElement.className = `chat-item ${isFavorite ? 'favorite' : ''}`;
                    
                    let avatarClass = 'chat-avatar';
                    if (chat.type === 'group') avatarClass += ' group';
                    if (chat.type === 'channel') avatarClass += ' channel';
                    if (isFavorite) avatarClass += ' favorite';
                    
                    const avatarText = chat.type === 'group' ? 'üë•' : 
                                      chat.type === 'channel' ? 'üì¢' : 
                                      chat.username ? chat.username.charAt(0).toUpperCase() : '?';
                    
                    const typeBadge = chat.type === 'group' ? '–ì–†–£–ü–ü–ê' : 
                                     chat.type === 'channel' ? '–ö–ê–ù–ê–õ' : '–õ–ò–ß–ù–´–ô';
                                     
                    const typeClass = `chat-type ${chat.type}`;
                    
                    chatElement.innerHTML = `
                        <div class="${avatarClass}">
                            ${avatarText}
                            ${chat.type === 'private' ? `
                                <div class="chat-status ${chat.is_online ? 'online' : 'offline'}"></div>
                            ` : ''}
                        </div>
                        <div class="chat-details">
                            <div class="chat-name">
                                ${chat.name}
                                <span class="${typeClass}">${typeBadge}</span>
                                ${isFavorite ? '<i class="fas fa-star" style="color: var(--favorite);"></i>' : ''}
                            </div>
                            <div class="chat-last-message">
                                ${chat.type === 'group' ? `${chat.members_count} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤` : 
                                  chat.type === 'channel' ? `${chat.members_count} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤` : 
                                  (chat.is_online ? 'online' : 'offline')}
                            </div>
                        </div>
                    `;
                    
                    chatElement.addEventListener('click', () => {
                        this.selectChat(chat);
                    });
                    
                    chatsList.appendChild(chatElement);
                });
            }

            selectChat(chat) {
                this.selectedChat = chat;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.currentTarget.classList.add('active');
                
                document.getElementById('chatWith').textContent = chat.name;
                
                let avatarClass = 'chat-avatar-large';
                if (chat.type === 'group') avatarClass += ' group';
                if (chat.type === 'channel') avatarClass += ' channel';
                
                document.getElementById('chatAvatar').className = avatarClass;
                document.getElementById('chatAvatar').textContent = 
                    chat.type === 'group' ? 'üë•' : 
                    chat.type === 'channel' ? 'üì¢' : 
                    chat.username ? chat.username.charAt(0).toUpperCase() : '?';
                
                if (chat.type === 'private') {
                    document.getElementById('chatStatus').innerHTML = `
                        ${chat.is_online ? 'online' : 'offline'}
                    `;
                } else {
                    document.getElementById('chatStatus').innerHTML = `
                        ${chat.type === 'group' ? `${chat.members_count} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤` : `${chat.members_count} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤`}
                    `;
                }
                
                document.getElementById('noChatSelected').style.display = 'none';
                document.getElementById('messages').classList.add('active');
                document.getElementById('inputArea').classList.add('active');
                document.getElementById('chatActions').style.display = 'flex';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
                this.loadMessageHistory();
                
                // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                document.getElementById('messageInput').focus();
            }

            async loadMessageHistory() {
                if (!this.selectedChat) return;
                
                try {
                    let url = '/api/messages?';
                    if (this.selectedChat.type === 'private') {
                        url += `user_id=${this.selectedChat.id}`;
                    } else {
                        url += `chat_id=${this.selectedChat.id}`;
                    }
                    
                    const response = await fetch(url);
                    const messages = await response.json();
                    
                    this.displayMessages(messages);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
                    this.displayTestMessages();
                }
            }

            displayMessages(messages) {
                const messagesContainer = document.getElementById('messages');
                messagesContainer.innerHTML = '';
                
                if (messages.length === 0) {
                    this.addWelcomeMessage();
                    return;
                }
                
                messages.forEach(msg => {
                    const isOwn = msg.from_user_id === this.currentUser.id;
                    this.displayMessage(msg, isOwn);
                });
                
                this.scrollToBottom();
            }

            addWelcomeMessage() {
                const messagesContainer = document.getElementById('messages');
                const welcomeDiv = document.createElement('div');
                welcomeDiv.className = 'message other';
                welcomeDiv.innerHTML = `
                    <div class="message-content" style="font-style: italic; opacity: 0.8;">
                        ${this.selectedChat.type === 'group' ? '–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ!' : 
                          this.selectedChat.type === 'channel' ? '–û–ø—É–±–ª–∏–∫—É–π—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª–µ!' : 
                          '–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥!'}
                    </div>
                    <div class="message-footer">
                        <div class="message-time">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                `;
                messagesContainer.appendChild(welcomeDiv);
            }

            displayMessage(messageData, isOwn) {
                const messagesContainer = document.getElementById('messages');
                
                const messageDiv = document.createElement('div');
                let messageClass = `message ${isOwn ? 'own' : 'other'}`;
                
                if (this.selectedChat.type === 'group') messageClass += ' group';
                if (this.selectedChat.type === 'channel') messageClass += ' channel';
                
                messageDiv.className = messageClass;
                messageDiv.dataset.messageId = messageData.id;
                
                const time = new Date(messageData.timestamp).toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø–∞—Ö –∏ –∫–∞–Ω–∞–ª–∞—Ö
                let senderHtml = '';
                if (!isOwn && (this.selectedChat.type === 'group' || this.selectedChat.type === 'channel')) {
                    senderHtml = `<div class="message-sender">${messageData.from_user_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>`;
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                let contentHtml = '';
                if (messageData.type === 'sticker' && messageData.sticker) {
                    contentHtml = `
                        <div class="message-sticker">
                            <img src="${messageData.sticker.url}" class="sticker-img" alt="${messageData.sticker.emoji}">
                        </div>
                    `;
                } else if (messageData.type === 'image' && messageData.image_url) {
                    contentHtml = `
                        <img src="${messageData.image_url}" class="message-image" onclick="openImage('${messageData.image_url}')">
                        ${messageData.caption ? `<div class="message-caption">${messageData.caption}</div>` : ''}
                    `;
                } else {
                    contentHtml = `<div class="message-content">${messageData.content}</div>`;
                }
                
                messageDiv.innerHTML = `
                    ${senderHtml}
                    ${contentHtml}
                    <div class="message-footer">
                        <div class="message-time">${time}</div>
                        ${isOwn ? `
                            <div class="message-status">
                                <i class="fas fa-check" style="font-size: 10px; opacity: 0.7;"></i>
                                ${messageData.read_at ? '<i class="fas fa-check" style="font-size: 10px;"></i>' : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            displayTestMessages() {
                const testMessages = [
                    {
                        id: 1,
                        from_user_id: 2,
                        from_user_name: "User Two",
                        content: '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?',
                        type: 'text',
                        timestamp: new Date(Date.now() - 300000).toISOString()
                    },
                    {
                        id: 2,
                        from_user_id: this.currentUser.id,
                        content: '–ü—Ä–∏–≤–µ—Ç! –í—Å–µ –æ—Ç–ª–∏—á–Ω–æ, —Ä–∞–±–æ—Ç–∞—é –Ω–∞–¥ –Ω–æ–≤—ã–º –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–æ–º!',
                        type: 'text',
                        timestamp: new Date(Date.now() - 240000).toISOString()
                    }
                ];
                
                this.displayMessages(testMessages);
            }

            setupWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/${this.currentUser.id}`;
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        this.handleWebSocketMessage(message);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    }
                };
                
                this.ws.onclose = () => {
                    console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                    setTimeout(() => this.setupWebSocket(), 3000);
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            }

            handleWebSocketMessage(message) {
                console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message);
                
                switch (message.type) {
                    case 'message':
                    case 'group_message':
                    case 'channel_message':
                    case 'sticker':
                    case 'image':
                        this.handleIncomingMessage(message);
                        break;
                    case 'message_sent':
                        this.handleMessageSent(message);
                        break;
                    case 'typing':
                        this.handleTypingIndicator(message);
                        break;
                    case 'read_receipt':
                        this.handleReadReceipt(message);
                        break;
                    case 'chat_deleted':
                        this.handleChatDeleted(message);
                        break;
                    case 'error':
                        console.error('‚ùå –û—à–∏–±–∫–∞:', message.message);
                        alert('–û—à–∏–±–∫–∞: ' + message.message);
                        break;
                }
            }

            handleIncomingMessage(message) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫ —Ç–µ–∫—É—â–µ–º—É —á–∞—Ç—É
                const isCurrentChat = this.selectedChat && (
                    (this.selectedChat.type === 'private' && 
                     (message.from_user_id === this.selectedChat.id || message.to_user_id === this.selectedChat.id)) ||
                    (this.selectedChat.type === 'group' && message.chat_id === this.selectedChat.id) ||
                    (this.selectedChat.type === 'channel' && message.chat_id === this.selectedChat.id)
                );
                
                if (isCurrentChat) {
                    const isOwn = message.from_user_id === this.currentUser.id;
                    this.displayMessage(message, isOwn);
                }
            }

            handleMessageSent(message) {
                console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, ID:', message.id);
            }

            handleTypingIndicator(message) {
                const typingIndicator = document.getElementById('typingIndicator');
                
                if (message.is_typing) {
                    this.typingUsers.add(message.from_user_id);
                    typingIndicator.classList.add('active');
                } else {
                    this.typingUsers.delete(message.from_user_id);
                    if (this.typingUsers.size === 0) {
                        typingIndicator.classList.remove('active');
                    }
                }
            }

            handleReadReceipt(message) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
                const messageElement = document.querySelector(`[data-message-id="${message.message_id}"]`);
                if (messageElement) {
                    const statusElement = messageElement.querySelector('.message-status');
                    if (statusElement) {
                        statusElement.innerHTML = '<i class="fas fa-check" style="font-size: 10px;"></i><i class="fas fa-check" style="font-size: 10px;"></i>';
                    }
                }
            }

            handleChatDeleted(message) {
                if (this.selectedChat) {
                    const messagesContainer = document.getElementById('messages');
                    messagesContainer.innerHTML = '';
                    this.addWelcomeMessage();
                }
            }

            sendMessage() {
                const input = document.getElementById('messageInput');
                const content = input.value.trim();
                
                if (!content && !this.uploadedFile) return;
                
                if (!this.selectedChat) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                    return;
                }
                
                if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                    alert('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                    return;
                }
                
                let messageData = {};
                
                if (this.uploadedFile) {
                    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞
                    if (this.uploadedFile.type.startsWith('image/')) {
                        messageData = {
                            type: 'image',
                            to_user_id: this.selectedChat.type === 'private' ? this.selectedChat.id : undefined,
                            chat_id: this.selectedChat.type !== 'private' ? this.selectedChat.id : undefined,
                            image_url: this.uploadedFile.url,
                            caption: content
                        };
                    } else {
                        // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ñ–∞–π–ª–æ–≤ –ø–æ–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç —Å —Å—Å—ã–ª–∫–æ–π
                        messageData = {
                            type: 'message',
                            to_user_id: this.selectedChat.type === 'private' ? this.selectedChat.id : undefined,
                            chat_id: this.selectedChat.type !== 'private' ? this.selectedChat.id : undefined,
                            content: `üìé ${this.uploadedFile.name}\n${content}`
                        };
                    }
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
                    this.uploadedFile = null;
                    this.clearUploadPreview();
                    
                } else {
                    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    messageData = {
                        type: this.selectedChat.type === 'channel' ? 'channel_message' : 
                              this.selectedChat.type === 'group' ? 'group_message' : 'message',
                        to_user_id: this.selectedChat.type === 'private' ? this.selectedChat.id : undefined,
                        chat_id: this.selectedChat.type !== 'private' ? this.selectedChat.id : undefined,
                        content: content
                    };
                }
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
                const sendButton = document.getElementById('sendButton');
                sendButton.disabled = true;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
                this.ws.send(JSON.stringify(messageData));
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', messageData);
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                input.value = '';
                this.autoResizeTextarea(input);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —á—Ç–æ –ø–µ—Ä–µ—Å—Ç–∞–ª–∏ –ø–µ—á–∞—Ç–∞—Ç—å
                this.sendTypingIndicator(false);
                
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    sendButton.disabled = false;
                }, 1000);
            }

            sendTypingIndicator(isTyping) {
                if (!this.selectedChat || !this.ws || this.ws.readyState !== WebSocket.OPEN) return;
                
                const typingData = {
                    type: 'typing',
                    is_typing: isTyping,
                    to_user_id: this.selectedChat.type === 'private' ? this.selectedChat.id : undefined,
                    chat_id: this.selectedChat.type !== 'private' ? this.selectedChat.id : undefined
                };
                
                this.ws.send(JSON.stringify(typingData));
            }

            sendSticker(stickerId) {
                if (!this.selectedChat || !this.ws || this.ws.readyState !== WebSocket.OPEN) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∏–∫–µ—Ä–∞');
                    return;
                }
                
                const stickerData = {
                    type: 'sticker',
                    sticker_id: stickerId,
                    to_user_id: this.selectedChat.type === 'private' ? this.selectedChat.id : undefined,
                    chat_id: this.selectedChat.type !== 'private' ? this.selectedChat.id : undefined
                };
                
                this.ws.send(JSON.stringify(stickerData));
                hideStickersModal();
            }

            async uploadFile(file) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('file_type', file.type.startsWith('image/') ? 'image' : 'file');
                    
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        return data.file;
                    } else {
                        throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª');
                    return null;
                }
            }

            async handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) { // 10MB
                    alert('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ 10MB');
                    return;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                const preview = document.getElementById('uploadPreview');
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    preview.innerHTML = `
                        <div>
                            <img src="${e.target.result}" class="preview-image">
                            <div class="preview-actions">
                                <button onclick="messenger.clearUploadPreview()" style="padding: 0.3rem 0.7rem; background: #ff4757; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-times"></i> –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `;
                    preview.classList.add('active');
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    const uploadedFile = await this.uploadFile(file);
                    if (uploadedFile) {
                        this.uploadedFile = {
                            ...uploadedFile,
                            name: file.name,
                            type: file.type
                        };
                    }
                };
                
                reader.readAsDataURL(file);
            }

            clearUploadPreview() {
                const preview = document.getElementById('uploadPreview');
                preview.innerHTML = '';
                preview.classList.remove('active');
                this.uploadedFile = null;
            }

            scrollToBottom() {
                const messagesContainer = document.getElementById('messages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            setupEventListeners() {
                const messageInput = document.getElementById('messageInput');
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter (Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // –ê–≤—Ç–æ—Ä–∞–∑–º–µ—Ä textarea
                messageInput.addEventListener('input', (e) => {
                    this.autoResizeTextarea(e.target);
                });
                
                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
                let typingTimer;
                messageInput.addEventListener('input', () => {
                    if (!this.selectedChat) return;
                    
                    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
                    clearTimeout(typingTimer);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —á—Ç–æ –ø–µ—á–∞—Ç–∞–µ–º
                    this.sendTypingIndicator(true);
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ "–ø–µ—Ä–µ—Å—Ç–∞–ª –ø–µ—á–∞—Ç–∞—Ç—å"
                    typingTimer = setTimeout(() => {
                        this.sendTypingIndicator(false);
                    }, 1000);
                });
                
                // –ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤
                document.getElementById('chatSearch').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    if (searchTerm) {
                        this.chats = this.allChats.filter(chat => 
                            chat.name.toLowerCase().includes(searchTerm) ||
                            (chat.description && chat.description.toLowerCase().includes(searchTerm))
                        );
                    } else {
                        this.applyCurrentFilter();
                    }
                    this.renderChatsList();
                });
            }

            renderStickerPacks() {
                const stickerPacks = document.getElementById('stickerPacks');
                stickerPacks.innerHTML = '';
                
                if (this.stickerPacks.length === 0) {
                    stickerPacks.innerHTML = '<p style="text-align: center; color: var(--text-muted);">–°—Ç–∏–∫–µ—Ä—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>';
                    return;
                }
                
                this.stickerPacks.forEach(pack => {
                    const packElement = document.createElement('div');
                    packElement.className = 'sticker-pack';
                    packElement.innerHTML = `
                        <div class="sticker-pack-header">
                            <div>
                                <div class="sticker-pack-name">${pack.name}</div>
                                <div class="sticker-pack-publisher">${pack.publisher}</div>
                            </div>
                        </div>
                        <div class="sticker-pack-stickers">
                            ${pack.stickers.map(sticker => `
                                <div class="sticker-item" onclick="messenger.sendSticker(${sticker.id})">
                                    <img src="${sticker.url}" alt="${sticker.emoji}">
                                </div>
                            `).join('')}
                        </div>
                    `;
                    stickerPacks.appendChild(packElement);
                });
            }

            renderAccountSwitcher() {
                const accountList = document.getElementById('accountList');
                accountList.innerHTML = '';
                
                // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–≤—ã–π
                const accounts = [this.currentUser, ...Array.from(this.loggedInAccounts.values()).filter(acc => acc.id !== this.currentUser.id)];
                
                accounts.forEach(account => {
                    const isCurrent = account.id === this.currentUser.id;
                    const accountElement = document.createElement('div');
                    accountElement.className = `account-item ${isCurrent ? 'active' : ''}`;
                    accountElement.innerHTML = `
                        <div class="account-avatar">${account.username.charAt(0).toUpperCase()}</div>
                        <div class="account-details">
                            <div class="account-name">
                                ${account.display_name}
                                ${account.is_guest ? '<span class="guest-badge">–ì–û–°–¢–¨</span>' : ''}
                                ${isCurrent ? '<span style="color: var(--primary);">‚úì</span>' : ''}
                            </div>
                            <div class="account-username">@${account.username}</div>
                        </div>
                    `;
                    
                    accountElement.addEventListener('click', () => {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
                        this.currentUser = account;
                        this.updateLeftMenu();
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º UI
                        document.querySelectorAll('.account-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        accountElement.classList.add('active');
                    });
                    
                    accountList.appendChild(accountElement);
                });
            }

            updateLeftMenu() {
                document.getElementById('currentAccountAvatar').textContent = 
                    this.currentUser.username.charAt(0).toUpperCase();
                document.getElementById('currentAccountName').textContent = this.currentUser.display_name;
                document.getElementById('currentAccountUsername').textContent = `@${this.currentUser.username}`;
                
                const guestBadge = document.getElementById('guestBadge');
                if (this.currentUser.is_guest) {
                    guestBadge.style.display = 'inline-block';
                } else {
                    guestBadge.style.display = 'none';
                }
            }

            saveLoggedInAccounts() {
                const accounts = Array.from(this.loggedInAccounts.values());
                localStorage.setItem('logged_in_accounts', JSON.stringify(accounts));
            }

            loadLoggedInAccounts() {
                const savedAccounts = localStorage.getItem('logged_in_accounts');
                if (savedAccounts) {
                    const accounts = JSON.parse(savedAccounts);
                    accounts.forEach(acc => this.loggedInAccounts.set(acc.id, acc));
                }
            }

            async createGroup() {
                const name = document.getElementById('groupName').value;
                const description = document.getElementById('groupDescription').value;
                const isPublic = document.getElementById('groupIsPublic').checked;
                
                if (!name.trim()) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã');
                    return;
                }
                
                try {
                    const formData = new FormData();
                    formData.append('name', name);
                    if (description) formData.append('description', description);
                    formData.append('is_public', isPublic.toString());
                    
                    const response = await fetch('/api/groups', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
                        hideNewGroupModal();
                        await this.loadChats();
                    } else {
                        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã: ' + data.detail);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É');
                }
            }

            async createChannel() {
                const name = document.getElementById('channelName').value;
                const description = document.getElementById('channelDescription').value;
                const isPublic = document.getElementById('channelIsPublic').checked;
                
                if (!name.trim()) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞');
                    return;
                }
                
                try {
                    const formData = new FormData();
                    formData.append('name', name);
                    if (description) formData.append('description', description);
                    formData.append('is_public', isPublic.toString());
                    
                    const response = await fetch('/api/channels', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!');
                        hideNewChannelModal();
                        await this.loadChats();
                    } else {
                        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞: ' + data.detail);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª');
                }
            }

            async registerUser() {
                const username = document.getElementById('registerUsername').value;
                const email = document.getElementById('registerEmail').value;
                const displayName = document.getElementById('registerDisplayName').value;
                const password = document.getElementById('registerPassword').value;
                
                if (!username.trim() || !email.trim() || !password.trim()) {
                    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                    return;
                }
                
                try {
                    const formData = new FormData();
                    formData.append('username', username);
                    formData.append('email', email);
                    formData.append('password', password);
                    if (displayName) formData.append('display_name', displayName);
                    
                    const response = await fetch('/api/register', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
                        hideRegisterModal();
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        this.currentUser = data.user;
                        this.loggedInAccounts.set(this.currentUser.id, this.currentUser);
                        this.saveLoggedInAccounts();
                        this.updateLeftMenu();
                        
                        // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º WebSocket
                        this.setupWebSocket();
                    } else {
                        alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + data.detail);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è');
                }
            }

            async autoCreateAccount() {
                try {
                    const response = await fetch('/api/auto-login', {
                        method: 'POST'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.currentUser = data.user;
                        this.loggedInAccounts.set(this.currentUser.id, this.currentUser);
                        this.saveLoggedInAccounts();
                        this.updateLeftMenu();
                        this.renderAccountSwitcher();
                        
                        alert('–ù–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω!');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç');
                }
            }

            async deleteChatHistory() {
                if (!this.selectedChat) return;
                
                try {
                    let url = '';
                    if (this.selectedChat.type === 'private') {
                        url = `/api/messages/for-all/${this.currentUser.id}/${this.selectedChat.id}`;
                    } else {
                        url = `/api/messages/for-all/${this.currentUser.id}/${this.selectedChat.id}`;
                    }
                    
                    const response = await fetch(url, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        const messagesContainer = document.getElementById('messages');
                        messagesContainer.innerHTML = '';
                        this.addWelcomeMessage();
                        
                        hideDeleteConfirm();
                        hideChatMenu();
                    } else {
                        alert(result.detail || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞');
                    }
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞');
                }
            }

            toggleFavorite() {
                if (!this.selectedChat) return;
                
                if (this.favoriteChats.has(this.selectedChat.id)) {
                    this.favoriteChats.delete(this.selectedChat.id);
                } else {
                    this.favoriteChats.add(this.selectedChat.id);
                }
                
                localStorage.setItem('favorite_chats', JSON.stringify([...this.favoriteChats]));
                this.applyCurrentFilter();
                hideChatMenu();
            }

            showAccountSwitcher() {
                this.renderAccountSwitcher();
                showModal('accountSwitcher');
                hideLeftMenu();
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        const messenger = new DevNetMessenger();

        function showLeftMenu() {
            document.getElementById('leftMenuOverlay').classList.add('active');
            document.getElementById('leftMenu').classList.add('active');
        }

        function hideLeftMenu() {
            document.getElementById('leftMenuOverlay').classList.remove('active');
            document.getElementById('leftMenu').classList.remove('active');
        }

        function toggleChatMenu() {
            const menu = document.getElementById('chatMenu');
            const overlay = document.getElementById('menuOverlay');
            
            if (menu.classList.contains('active')) {
                hideChatMenu();
            } else {
                menu.classList.add('active');
                overlay.classList.add('active');
            }
        }

        function hideChatMenu() {
            document.getElementById('chatMenu').classList.remove('active');
            document.getElementById('menuOverlay').classList.remove('active');
        }

        function switchTab(tabName) {
            messenger.currentTab = tabName;
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            messenger.applyCurrentFilter();
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showNewGroupModal() {
            showModal('newGroupModal');
            hideLeftMenu();
        }

        function hideNewGroupModal() {
            hideModal('newGroupModal');
        }

        function showNewChannelModal() {
            showModal('newChannelModal');
            hideLeftMenu();
        }

        function hideNewChannelModal() {
            hideModal('newChannelModal');
        }

        function showRegisterModal() {
            showModal('registerModal');
            hideLeftMenu();
        }

        function hideRegisterModal() {
            hideModal('registerModal');
        }

        function showStickersModal() {
            messenger.renderStickerPacks();
            showModal('stickersModal');
        }

        function hideStickersModal() {
            hideModal('stickersModal');
        }

        function showDeleteConfirm() {
            hideChatMenu();
            if (!messenger.selectedChat) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }
            showModal('confirmModal');
        }

        function hideDeleteConfirm() {
            hideModal('confirmModal');
        }

        function showAccountSwitcher() {
            messenger.showAccountSwitcher();
        }

        function hideAccountSwitcher() {
            hideModal('accountSwitcher');
        }

        function switchAccount() {
            // –£–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –∫–ª–∞—Å—Å–µ
            hideAccountSwitcher();
        }

        function autoCreateAccount() {
            messenger.autoCreateAccount();
        }

        function createGroup() {
            messenger.createGroup();
        }

        function createChannel() {
            messenger.createChannel();
        }

        function registerUser() {
            messenger.registerUser();
        }

        function deleteChatHistory() {
            messenger.deleteChatHistory();
        }

        function toggleFavorite() {
            messenger.toggleFavorite();
        }

        function openFavorites() {
            messenger.currentTab = 'all';
            messenger.applyCurrentFilter();
            hideLeftMenu();
        }

        function attachImage() {
            document.getElementById('imageUpload').click();
        }

        function attachFile() {
            document.getElementById('fileUpload').click();
        }

        function handleImageUpload(event) {
            messenger.handleImageUpload(event);
        }

        function handleFileUpload(event) {
            // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            messenger.handleImageUpload(event);
        }

        function openImage(url) {
            window.open(url, '_blank');
        }

        function sendMessage() {
            messenger.sendMessage();
        }

        async function logout() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) return;
            
            try {
                await fetch('/api/logout', {
                    method: 'POST'
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
            } finally {
                localStorage.clear();
                window.location.href = '/';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            messenger.init();
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideChatMenu();
                hideDeleteConfirm();
                hideAccountSwitcher();
                hideLeftMenu();
                hideModal('newGroupModal');
                hideModal('newChannelModal');
                hideModal('registerModal');
                hideModal('stickersModal');
            }
        });
    </script>
</body>
</html>
